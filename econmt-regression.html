
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Regression &#8212; Coding for Economists</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://aeturrell.github.io/coding-for-economists/econmt-regression.html" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Causal Inference" href="econmt-causal-inference.html" />
    <link rel="prev" title="Statistics" href="econmt-statistics.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9FZQCPFXZJ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-9FZQCPFXZJ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/smith_lovelace.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Coding for Economists</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="code-preliminaries.html">
   Preliminaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="code-basics.html">
   Coding Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="workflow-basics.html">
   Workflow Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="code-where.html">
   Writing Code
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="data-analysis-quickstart.html">
   Data Analysis Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-intro.html">
   Working with Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-transformation.html">
   Data Transformation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-read-and-write.html">
   Reading and Writing Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-numbers.html">
   Numbers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-categorical.html">
   Categorical Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-boolean.html">
   Boolean Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-joining-data.html">
   Joins
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Coding
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="code-best-practice.html">
   Code in Style
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="code-advanced.html">
   More Coding
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Econometrics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="econmt-probability-random.html">
   Probability and Random Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="econmt-statistics.html">
   Statistics
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="econmt-causal-inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="econmt-bayesian.html">
   Bayesian Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="econmt-bayes-bambi.html">
   Bayesian Inference Made Easier
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Visualisation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="vis-intro.html">
   Intro to Data Visualisation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vis-seaborn.html">
   Easy Data Visualisation for Tidy Data with
   <strong>
    Seaborn
   </strong>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vis-matplotlib.html">
   Powerful Data Visualisation with
   <strong>
    Matplotlib
   </strong>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vis-common-plots.html">
   Common Plots
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vis-narrative.html">
   Narrative Data Visualisation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Workflow
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="auto-research-outputs.html">
   Automating Research Outputs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-markdown.html">
   Markdown
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-quarto.html">
   Combining Code and Text in Quarto Markdown
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  More Data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="data-missing-values.html">
   Missing Values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-exploratory-analysis.html">
   Exploratory Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-spreadsheets.html">
   Spreadsheets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-extraction.html">
   Getting Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-databases.html">
   Databases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-sharing.html">
   Sharing Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data-advanced.html">
   Advanced Data
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  More Coding
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="code-advcd-best-practice.html">
   Essential Tricks for Better Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="code-further-advanced.html">
   Yet More Coding
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  More Workflow
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-command-line.html">
   The Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-version-control.html">
   Version Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-environments.html">
   Virtual Code Environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="wrkflow-rap.html">
   Reproducible Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Craft
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="craft-intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="craft-search.html">
   Putting the Search in Research
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="craft-writing-papers.html">
   Writing Papers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="craft-research-blogs.html">
   Research Blog Posts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="craft-technical-reports.html">
   Writing Technical Reports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="craft-extended-abstracts.html">
   Extended Abstracts
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="time-intro.html">
   Introduction to Time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="time-series.html">
   Time Series
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="time-fcasts-env.html">
   Forecasting Exercises
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Text Analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="text-intro.html">
   Introduction to Text
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="text-regex.html">
   Regular Expressions, aka regex
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="text-nlp.html">
   Natural Language Processing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Geospatial
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="geo-intro.html">
   Intro to Geo-Spatial Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="geo-vis.html">
   Geo-Spatial Visualisation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  More Data Visualisation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="vis-plotnine.html">
   Data Visualisation using the Grammar of Graphics with Plotnine
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vis-animation.html">
   Animation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Mathematics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="maths-abstract.html">
   Abstract Mathematics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maths-numerical.html">
   Numerical Mathematics
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Coming from ...
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="coming-from-stata.html">
   Coming from Stata
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coming-from-matlab.html">
   Coming from Matlab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coming-from-r.html">
   Coming from R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coming-from-excel.html">
   Coming from Excel
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  End Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="acknowledgements.html">
   Acknowledgements and Contributing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://colab.research.google.com/github/aeturrell/coding-for-economists/blob/main/econmt-regression.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/aeturrell/coding-for-economists"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/aeturrell/coding-for-economists/issues/new?title=Issue%20on%20page%20%2Feconmt-regression.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/econmt-regression.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quick-review-of-econometrics">
   Quick Review of Econometrics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#notation">
     Notation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gauss-markov-conditions">
     Gauss-Markov Conditions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-vs-random-effects">
     Fixed vs Random Effects
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-basics">
   Regression basics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#robust-regression">
     Robust regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standard-errors">
     Standard errors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clustered-standard-errors">
       Clustered standard errors
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fixed-effects-and-categorical-variables">
   Fixed effects and categorical variables
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-dimensional-fixed-effects-aka-absorbing-regression">
     High dimensional fixed effects, aka absorbing regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transformations-of-regressors">
   Transformations of regressors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logs-and-arcsinh">
     Logs and arcsinh
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interaction-terms-and-powers">
     Interaction terms and powers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-formula-api-explained">
   The formula API explained
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multiple-regression-models">
   Multiple regression models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#specifying-regressions-without-formulae-using-the-array-api">
   Specifying regressions without formulae, using the array API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-effects-in-the-array-api">
     Fixed effects in the array API
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#instrumental-variables">
   Instrumental variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logit-probit-and-generalised-linear-models">
   Logit, probit, and generalised linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logit">
     Logit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#probit">
     Probit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generalised-linear-models">
     Generalised linear models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-mixed-effects-regressions-lmer">
   Linear Mixed Effects Regressions (LMER)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-probability-model">
   Linear probability model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#violations-of-the-classical-linear-model-clm">
   Violations of the classical linear model (CLM)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#heteroskedasticity">
     Heteroskedasticity
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quantile-regression">
   Quantile regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rolling-and-recursive-regressions">
   Rolling and recursive regressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-plots">
   Regression plots
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#binscatter">
   Binscatter
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#specification-curve-analysis">
   Specification curve analysis
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#review">
   Review
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Regression</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quick-review-of-econometrics">
   Quick Review of Econometrics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#notation">
     Notation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gauss-markov-conditions">
     Gauss-Markov Conditions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-vs-random-effects">
     Fixed vs Random Effects
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-basics">
   Regression basics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#robust-regression">
     Robust regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standard-errors">
     Standard errors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clustered-standard-errors">
       Clustered standard errors
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fixed-effects-and-categorical-variables">
   Fixed effects and categorical variables
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-dimensional-fixed-effects-aka-absorbing-regression">
     High dimensional fixed effects, aka absorbing regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transformations-of-regressors">
   Transformations of regressors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logs-and-arcsinh">
     Logs and arcsinh
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interaction-terms-and-powers">
     Interaction terms and powers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-formula-api-explained">
   The formula API explained
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multiple-regression-models">
   Multiple regression models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#specifying-regressions-without-formulae-using-the-array-api">
   Specifying regressions without formulae, using the array API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-effects-in-the-array-api">
     Fixed effects in the array API
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#instrumental-variables">
   Instrumental variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logit-probit-and-generalised-linear-models">
   Logit, probit, and generalised linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logit">
     Logit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#probit">
     Probit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generalised-linear-models">
     Generalised linear models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-mixed-effects-regressions-lmer">
   Linear Mixed Effects Regressions (LMER)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-probability-model">
   Linear probability model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#violations-of-the-classical-linear-model-clm">
   Violations of the classical linear model (CLM)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#heteroskedasticity">
     Heteroskedasticity
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quantile-regression">
   Quantile regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rolling-and-recursive-regressions">
   Rolling and recursive regressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-plots">
   Regression plots
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#binscatter">
   Binscatter
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#specification-curve-analysis">
   Specification curve analysis
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#review">
   Review
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="regression">
<span id="id1"></span><h1>Regression<a class="headerlink" href="#regression" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>In this chapter, you’ll learn how to run linear regressions with code.</p>
<p>If you’re running this code (either by copying and pasting it, or by downloading it using the icons at the top of the page), you may need to install the packages it uses first. There’s a brief guide to installing packages in the Chapter on <a class="reference internal" href="code-preliminaries.html#code-preliminaries"><span class="std std-ref">Preliminaries</span></a>.</p>
<p>Most of this chapter will rely on <a class="reference external" href="https://www.statsmodels.org/stable/index.html">statsmodels</a> with some use of <a class="reference external" href="https://bashtage.github.io/linearmodels/"><strong>linearmodels</strong></a>. Some of the material in this chapter follows <a class="reference external" href="https://grantmcdermott.com/">Grant McDermott</a>’s excellent notes and the <a class="reference external" href="https://lost-stats.github.io/">Library of Statistical Translation</a>.</p>
</section>
<section id="quick-review-of-econometrics">
<h2>Quick Review of Econometrics<a class="headerlink" href="#quick-review-of-econometrics" title="Permalink to this headline">#</a></h2>
<section id="notation">
<h3>Notation<a class="headerlink" href="#notation" title="Permalink to this headline">#</a></h3>
<p>Greek letters, like <span class="math notranslate nohighlight">\(\beta\)</span>, are the truth and represent parameters. Modified Greek letters are an estimate of the truth, for example <span class="math notranslate nohighlight">\(\hat{\beta}\)</span>. Sometimes Greek letters will stand in for vectors of parameters. Most of the time, upper case Latin characters such as <span class="math notranslate nohighlight">\(X\)</span> will represent random variables (which could have more than one dimension). Lower case letters from the Latin alphabet denote realised data, for instance <span class="math notranslate nohighlight">\(x\)</span> (which again could be multi-dimensional).  Modified Latin alphabet letters denote computations performed on data, for instance <span class="math notranslate nohighlight">\(\bar{x} = \frac{1}{n} \displaystyle\sum_{i} x_i\)</span> where <span class="math notranslate nohighlight">\(n\)</span> is number of samples.</p>
<p>Ordinary least squares (OLS) regression can be used to <em>estimate</em> the parameters of certain types of model, most typically models of the form</p>
<div class="math notranslate nohighlight">
\[
y = \beta_0 + \beta_1 \cdot x_1 + \beta_2 \cdot x_2
\]</div>
<p>This generic model says that the value of an outcome variable <span class="math notranslate nohighlight">\(y\)</span> is a linear function of one or more input predictor variables <span class="math notranslate nohighlight">\(x_i\)</span>, where the <span class="math notranslate nohighlight">\(x_i\)</span> could be transforms of original data. But the above equation is a platonic ideal, what we call a data generating process (DGP). OLS allows us to recover <em>estimates</em> of the parameters of the model , i.e. to find <span class="math notranslate nohighlight">\(\hat{\beta_i}\)</span> and to enable us to write an estimated model:</p>
<div class="math notranslate nohighlight">
\[
y = \hat{\beta_0} + \hat{\beta_1} \cdot x_1 + \hat{\beta_2} \cdot x_2 + \epsilon
\]</div>
<p>This equation can also be expressed in matrix form as</p>
<div class="math notranslate nohighlight">
\[
y = x'\cdot \hat{\beta} + \epsilon
\]</div>
<p>where <span class="math notranslate nohighlight">\(x' = (1, x_1, \dots, x_{n})'\)</span> and <span class="math notranslate nohighlight">\(\hat{\beta} = (\hat{\beta_0}, \hat{\beta_1}, \dots, \hat{\beta_{n}})\)</span>.</p>
<p>Given data <span class="math notranslate nohighlight">\(y_i\)</span> stacked to make a vector <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(x_{i}\)</span> stacked to make a matrix <span class="math notranslate nohighlight">\(X\)</span>, this can be solved for the coefficients <span class="math notranslate nohighlight">\(\hat{\beta}\)</span> according to</p>
<div class="math notranslate nohighlight">
\[
\hat{\beta} = \left(X'X\right)^{-1} X'y
\]</div>
</section>
<section id="gauss-markov-conditions">
<h3>Gauss-Markov Conditions<a class="headerlink" href="#gauss-markov-conditions" title="Permalink to this headline">#</a></h3>
<p>To be sure that the estimates of these parameters are the <em>best linear unbiased estimate</em>, a few conditions need to hold: the Gauss-Markov conditions:</p>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(y\)</span> is a linear function of the <span class="math notranslate nohighlight">\(\beta_i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(y\)</span> and the <span class="math notranslate nohighlight">\(x_i\)</span> are randomly sampled from the population.</p></li>
<li><p>There is no perfect multi-collinearity of variables.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{E}(\epsilon | x_1, \dots, x_n) = 0\)</span> (unconfoundedness)</p></li>
<li><p><span class="math notranslate nohighlight">\(\text{Var}(\epsilon | x_1, \dots, x_n) = \sigma^2\)</span> (homoskedasticity)</p></li>
</ol>
<p>(1)-(4) also guarantee that OLS estimates are unbiased and <span class="math notranslate nohighlight">\(\mathbb{E}(\hat{\beta}_i) = \beta_i\)</span>.</p>
<p>The classic linear model requires a 6th assumption; that <span class="math notranslate nohighlight">\(\epsilon \thicksim \mathcal{N}(0, \sigma^2)\)</span>.</p>
<p>The interpretation of regression coefficients depends on what their units are to begin with, but you can always work it out by differentiating both sides of the model equation with respect to the <span class="math notranslate nohighlight">\(x_i\)</span>. For example, for the first model equation above</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial y}{\partial x_i} = \beta_i
\]</div>
<p>so we get the interpretation that <span class="math notranslate nohighlight">\(\beta_i\)</span> is the rate of change of y with respect to <span class="math notranslate nohighlight">\(x_i\)</span>. If <span class="math notranslate nohighlight">\(x_i\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are in levels, this means that a unit increase in <span class="math notranslate nohighlight">\(x_i\)</span> is associated with a <span class="math notranslate nohighlight">\(\beta_i\)</span> units increase in <span class="math notranslate nohighlight">\(y\)</span>. If the right-hand side of the model is <span class="math notranslate nohighlight">\(\ln x_i\)</span> then we get</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial y}{\partial x_i} = \beta_i \frac{1}{x_i} 
\]</div>
<p>with some abuse of notation, we can rewrite this as <span class="math notranslate nohighlight">\(\partial y = \beta_i \partial x_i/x_i\)</span>, which says that a percent change in <span class="math notranslate nohighlight">\(x_i\)</span> is associated with a <span class="math notranslate nohighlight">\(\beta_i\)</span> unit change in <span class="math notranslate nohighlight">\(y\)</span>. With a logged <span class="math notranslate nohighlight">\(y\)</span> variable, it’s a percent change in <span class="math notranslate nohighlight">\(x_i\)</span> that is associated with a percent change in <span class="math notranslate nohighlight">\(y\)</span>, or <span class="math notranslate nohighlight">\(\partial y/y = \beta_i \partial x_i/x_i\)</span> (note that both sides of this equation are unitless in this case). Finally, another example that is important in practice is that of log differences, eg <span class="math notranslate nohighlight">\(y = \beta_i (\ln x_i - \ln x_i')\)</span>. Again, we will abuse notation and say that this case may be represented as <span class="math notranslate nohighlight">\(\partial y = \beta_i (\partial x_i/x_i - \partial x_i'/x_i')\)</span>, i.e. the difference in two percentages, a <em>percentage point</em> change, in <span class="math notranslate nohighlight">\(x_i\)</span> is associated with a <span class="math notranslate nohighlight">\(\beta_i\)</span> unit change in <span class="math notranslate nohighlight">\(y\)</span>.</p>
</section>
<section id="fixed-vs-random-effects">
<h3>Fixed vs Random Effects<a class="headerlink" href="#fixed-vs-random-effects" title="Permalink to this headline">#</a></h3>
<p>As this is going to come up in this chapter, it’s worth having a quick review of the difference between fixed and random effects in regression-based models. There’s a bit of disagreement about what people really mean when they say “fixed effects” or “random effects”, so let’s define them clearly here.</p>
<blockquote>
<div><p>Random effects are estimated with partial pooling, while fixed effects are not.</p>
</div></blockquote>
<p>What does this mean? Well, technically, if an effect is assumed to be a realised value of a random variable, it is called a random effect. We could say that, in frequentist land (where parameters have true values), a single fixed effect model might look like:</p>
<div class="math notranslate nohighlight">
\[
y = \gamma\cdot d
\]</div>
<p>where <span class="math notranslate nohighlight">\(d \in \{0, 1\}\)</span>, which could be whether an individual belongs to, say, group 0 or group 1 and <span class="math notranslate nohighlight">\(\gamma\)</span> is a coefficient that is to be estimated. <span class="math notranslate nohighlight">\(\gamma\)</span> has a single “true” value, and we can admire the value of <span class="math notranslate nohighlight">\(\hat{\gamma}\)</span> in a regression table once we have done our estimation.</p>
<p>In contrast, even in a frequentist model, random effects are allowed to vary: they are drawn from a distribution (or, more accurately, their deviations from the true value are drawn from a distribution). This might be written as</p>
<div class="math notranslate nohighlight">
\[
y_{i}= w_{i}
\]</div>
<p>and it could be that, instead of a group-specific intercept as in the fixed effects model above, the intercept can take a <em>range of values</em> depending on the individual. Although it’s not always true, another way of thinking about this is that fixed effects are constant across individuals while random effects can vary.</p>
<p>So what’s this business about partial pooling? Imagine we have a situation where one group is under-sampled relative to the other groups. With few data points, we may not be able to precisely estimate fixed effects. However, partial pooling means that, if you do have few data points within a group, the group effect estimate can be partially based on the more abundant data from other groups. Random effects can provide a good compromise between estimating an effect by completely pooling all groups, which masks group-level variation, and estimating an effect for all groups completely separately, which could give imprecise estimates for low-sample groups. For example, when estimating means using a random effects approach, subgroup means are allowed to deviate a bit from the mean of the larger group, but not by an arbitrary amount—those deviations follow a distribution, typically a Gaussian (aka Normal) distribution. That’s where the “random” in random effects comes from: the deviations of subgroups from a “parent group” follow the distribution of a random variable.</p>
<p>The rule of thumb when thinking about how many different categories should exist for a variable to get the random, rather than fixed, effects treatment is that there should be more than 5 or 6 levels at a minimum in order to apply random effects—fewer than this and it’s hard to estimate the variance around the central estimate. Because you could potentially precisely estimated a fixed effect if you had lots of samples in those 5 or 6 levels, you’re more likely to reach for random effects when you have fewer samples per class.</p>
<p>Random effects are the extension of this partial pooling technique to a wide range of situations: including multiple predictors, mixed continuous and categorical variables, and more.</p>
<p>As a conrete example, taken from a <a class="reference external" href="https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode">forum post</a> by Paul of MassMutual, suppose you want to estimate average US household income by ZIP code. You have a large dataset containing observations of household incomes and ZIP codes. Some ZIP codes are well represented in the dataset, but others have only a couple of households.</p>
<p>For your initial model you would most likely take the mean income in each ZIP. This will work well when you have lots of data for all ZIPs, but the estimates for your poorly sampled ZIPs will suffer from high variance. You can mitigate this by using a shrinkage estimator (aka partial pooling), which will push extreme values towards the mean income across all ZIP codes.</p>
<p>But how much shrinkage/pooling should you do for a particular ZIP? Intuitively, it should depend on the following:</p>
<ol class="simple">
<li><p>How many observations you have in that ZIP</p></li>
<li><p>How many observations you have overall</p></li>
<li><p>The individual-level mean and variance of household income across all ZIP codes</p></li>
<li><p>The group-level variance in mean household income across all ZIP codes</p></li>
</ol>
<p>Now, if you model ZIP code as a random effect, the mean income estimate in all ZIP codes will be subjected to a statistically well-founded shrinkage, taking into account all of these factors.</p>
<p>Random effects models automatically handle 4, the variability estimation, for all random effects in the model. This is useful, as it would be hard to do manually. Having accounted for (1)–(4), a random effects model is able to determine the appropriate shrinkage for low-sample groups. It can also handle much more complicated models with many different predictors.</p>
<p><strong>Mixed effects models</strong> are models that combine random and fixed effects.</p>
</section>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">#</a></h2>
<p>Let’s import some of the packages we’ll be using:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="regression-basics">
<h2>Regression basics<a class="headerlink" href="#regression-basics" title="Permalink to this headline">#</a></h2>
<p>There are two ways to run regressions in <a class="reference external" href="https://www.statsmodels.org/stable/index.html"><strong>statsmodels</strong></a>; passing the data directly as objects, and using formulae. We’ll see both but, just to get things started, let’s use the formula API.</p>
<p>We’ll use the starwars dataset to run a regression of mass on height for star wars characters. This example borrows very heavily from notes by <a class="reference external" href="https://grantmcdermott.com/">Grant McDermott</a>. First, let’s bring the dataset in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/aeturrell/coding-for-economists/raw/main/data/starwars.csv&quot;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Look at first few rows</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>height</th>
      <th>mass</th>
      <th>hair_color</th>
      <th>eye_color</th>
      <th>gender</th>
      <th>homeworld</th>
      <th>species</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Luke Skywalker</td>
      <td>172.0</td>
      <td>77.0</td>
      <td>blond</td>
      <td>blue</td>
      <td>male</td>
      <td>Tatooine</td>
      <td>Human</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C-3PO</td>
      <td>167.0</td>
      <td>75.0</td>
      <td>NaN</td>
      <td>yellow</td>
      <td>NaN</td>
      <td>Tatooine</td>
      <td>Droid</td>
    </tr>
    <tr>
      <th>2</th>
      <td>R2-D2</td>
      <td>96.0</td>
      <td>32.0</td>
      <td>NaN</td>
      <td>red</td>
      <td>NaN</td>
      <td>Naboo</td>
      <td>Droid</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Darth Vader</td>
      <td>202.0</td>
      <td>136.0</td>
      <td>none</td>
      <td>yellow</td>
      <td>male</td>
      <td>Tatooine</td>
      <td>Human</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Leia Organa</td>
      <td>150.0</td>
      <td>49.0</td>
      <td>brown</td>
      <td>brown</td>
      <td>female</td>
      <td>Alderaan</td>
      <td>Human</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Okay, now let’s do a regression using OLS and a formula that says our y-variable is mass and our regressor is height:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Well, where are the results!? They’re stored in the object we created. To peek at them we need to call the summary function (and, for easy reading, I’ll print it out too using <code class="docutils literal notranslate"><span class="pre">print</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                   mass   R-squared:                       0.018
Model:                            OLS   Adj. R-squared:                  0.001
Method:                 Least Squares   F-statistic:                     1.040
Date:                Wed, 01 Feb 2023   Prob (F-statistic):              0.312
Time:                        00:42:45   Log-Likelihood:                -385.50
No. Observations:                  59   AIC:                             775.0
Df Residuals:                      57   BIC:                             779.2
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -13.8103    111.155     -0.124      0.902    -236.393     208.773
height         0.6386      0.626      1.020      0.312      -0.615       1.892
==============================================================================
Omnibus:                      128.880   Durbin-Watson:                   2.025
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             7330.447
Skew:                           7.340   Prob(JB):                         0.00
Kurtosis:                      55.596   Cond. No.                         895.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<p>What we’re seeing here are really several tables glued together. To just grab the coefficients in a tidy format, use</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>  -13.8103</td> <td>  111.155</td> <td>   -0.124</td> <td> 0.902</td> <td> -236.393</td> <td>  208.773</td>
</tr>
<tr>
  <th>height</th>    <td>    0.6386</td> <td>    0.626</td> <td>    1.020</td> <td> 0.312</td> <td>   -0.615</td> <td>    1.892</td>
</tr>
</table></div></div>
</div>
<p>You’ll have noticed that we got an intercept, even though we didn’t specify one in the formula. <strong>statsmodels</strong> adds in an intercept by default because, most of the time, you will want one. To turn it off, add a <code class="docutils literal notranslate"><span class="pre">-1</span></code> at the end of the formula command, eg in this case you would call <code class="docutils literal notranslate"><span class="pre">smf.ols('mass</span> <span class="pre">~</span> <span class="pre">height</span> <span class="pre">-1',</span> <span class="pre">data=df).fit()</span></code>.</p>
<p>The fit we got in the case with the intercept was pretty terrible; a low <span class="math notranslate nohighlight">\(R^2\)</span> and both of our confidence intervals are large and contain zero. What’s going on? If there’s one adage in regression that’s always worth paying attention to, it’s <em>always plot your data</em>. Let’s see what’s going on here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;Jabba the Hutt&quot;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()][[</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">]],</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;fancy&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3,rad=0.3&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Always plot the data&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_15_0.svg" src="_images/econmt-regression_15_0.svg" /></div>
</div>
<p>Oh dear, Jabba’s been on the paddy frogs again, and he’s a bit of different case. When we’re estimating statistical relationships, we have all kinds of choices and should be wary about arbitrary decisions of what to include or exclude in case we fool ourselves about the generality of the relationship we are capturing. Let’s say we knew that we weren’t interested in Hutts though, but only in other species: in that case, it’s fair enough to filter out Jabba and run the regression without this obvious outlier. We’ll exclude any entry that contains the string ‘Jabba’ in the <code class="docutils literal notranslate"><span class="pre">name</span></code> column:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_outlier_free</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span>
    <span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Jabba&quot;</span><span class="p">)]</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_outlier_free</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                   mass   R-squared:                       0.580
Model:                            OLS   Adj. R-squared:                  0.572
Method:                 Least Squares   F-statistic:                     77.18
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           4.02e-12
Time:                        00:42:46   Log-Likelihood:                -252.48
No. Observations:                  58   AIC:                             509.0
Df Residuals:                      56   BIC:                             513.1
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -32.5408     12.561     -2.591      0.012     -57.703      -7.379
height         0.6214      0.071      8.785      0.000       0.480       0.763
==============================================================================
Omnibus:                        9.951   Durbin-Watson:                   1.657
Prob(Omnibus):                  0.007   Jarque-Bera (JB):               10.072
Skew:                           0.793   Prob(JB):                      0.00650
Kurtosis:                       4.285   Cond. No.                         888.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<p>This looks a lot more healthy. Not only is the model explaining a <em>lot</em> more of the data, but the coefficients are now significant.</p>
<section id="robust-regression">
<h3>Robust regression<a class="headerlink" href="#robust-regression" title="Permalink to this headline">#</a></h3>
<p>Filtering out data is one way to deal with outliers, but it’s not the only one; an alternative is to use a regression technique that is robust to such outliers. <strong>statsmodels</strong> has a variety of robust linear models that you can read more about <a class="reference external" href="https://www.statsmodels.org/stable/examples/notebooks/generated/robust_models_0.html">here</a>. To demonstrate the general idea, we will run the regression again but using a robust method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_robust</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">rlm</span><span class="p">(</span>
    <span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">robust</span><span class="o">.</span><span class="n">norms</span><span class="o">.</span><span class="n">TrimmedMean</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_robust</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                    Robust linear Model Regression Results                    
==============================================================================
Dep. Variable:                   mass   No. Observations:                   59
Model:                            RLM   Df Residuals:                       57
Method:                          IRLS   Df Model:                            1
Norm:                     TrimmedMean                                         
Scale Est.:                       mad                                         
Cov Type:                          H1                                         
Date:                Wed, 01 Feb 2023                                         
Time:                        00:42:46                                         
No. Iterations:                     7                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -31.4968      2.180    -14.451      0.000     -35.769     -27.225
height         0.6273      0.012     51.102      0.000       0.603       0.651
==============================================================================

If the model instance has been used for another fit with different fit parameters, then the fit options might not be the correct ones anymore .
</pre></div>
</div>
</div>
</div>
<p>There are many different ‘M-estimators’ available; in this case the TrimmedMean estimator gives a very similar result to the regression with the point excluded. We can visualise this, and, well, the results are not really very different in this case. Note that <code class="docutils literal notranslate"><span class="pre">abline_plot</span></code> just takes an intercept and coefficient from a fitted model and renders the line that they encode.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">])</span>
<span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">abline_plot</span><span class="p">(</span><span class="n">model_results</span><span class="o">=</span><span class="n">results_robust</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Robust&quot;</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">abline_plot</span><span class="p">(</span>
    <span class="n">model_results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;OLS&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Height&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_22_0.svg" src="_images/econmt-regression_22_0.svg" /></div>
</div>
</section>
<section id="standard-errors">
<h3>Standard errors<a class="headerlink" href="#standard-errors" title="Permalink to this headline">#</a></h3>
<p>You’ll have seen that there’s a column for the standard error of the estimates in the regression table and a message saying that the covariance type of these is ‘nonrobust’. Let’s say that, instead, we want to use Eicker-Huber-White robust standard errors, aka “HC2” standard errors. We can specify to use these up front standard errors up front in the fit method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;HC2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>  -13.8103</td> <td>   23.456</td> <td>   -0.589</td> <td> 0.556</td> <td>  -59.782</td> <td>   32.162</td>
</tr>
<tr>
  <th>height</th>    <td>    0.6386</td> <td>    0.088</td> <td>    7.263</td> <td> 0.000</td> <td>    0.466</td> <td>    0.811</td>
</tr>
</table></div></div>
</div>
<p>Or, alternatively, we can go back to our existing results and recompute the results from those:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get_robustcov_results</span><span class="p">(</span><span class="s2">&quot;HC2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                   mass   R-squared:                       0.018
Model:                            OLS   Adj. R-squared:                  0.001
Method:                 Least Squares   F-statistic:                     52.75
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           1.16e-09
Time:                        00:42:46   Log-Likelihood:                -385.50
No. Observations:                  59   AIC:                             775.0
Df Residuals:                      57   BIC:                             779.2
Df Model:                           1                                         
Covariance Type:                  HC2                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -13.8103     23.456     -0.589      0.558     -60.779      33.159
height         0.6386      0.088      7.263      0.000       0.463       0.815
==============================================================================
Omnibus:                      128.880   Durbin-Watson:                   2.025
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             7330.447
Skew:                           7.340   Prob(JB):                         0.00
Kurtosis:                      55.596   Cond. No.                         895.
==============================================================================

Notes:
[1] Standard Errors are heteroscedasticity robust (HC2)
</pre></div>
</div>
</div>
</div>
<p>There are several different types of standard errors available in <strong>statsmodels</strong>:</p>
<ul class="simple">
<li><p>‘HC0’, ‘HC1’, ‘HC2’, and ‘HC3’</p></li>
<li><p>‘HAC’, for heteroskedasticity and autocorrelation consistent standard errors, for which you may want to also use some keyword arguments</p></li>
<li><p>‘hac-groupsum’, for Driscoll and Kraay heteroscedasticity and
autocorrelation robust standard errors in panel data, again for which you may have to specify extra keyword arguments</p></li>
<li><p>‘hac-panel’, for heteroscedasticity and autocorrelation robust standard
errors in panel data, again with keyword arguments; and</p></li>
<li><p>‘cluster’ for clustered standard errors.</p></li>
</ul>
<p>You can find information on all of these <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.regression.linear_model.OLSResults.get_robustcov_results.html?highlight=get_robustcov_results#statsmodels.regression.linear_model.OLSResults.get_robustcov_results">here</a>. For more on standard errors in python, <a class="reference external" href="http://www.vincentgregoire.com/standard-errors-in-python/">this is a good</a> link.</p>
<p>For now, let’s look more closely at those last ones: clustered standard errors.</p>
<section id="clustered-standard-errors">
<h4>Clustered standard errors<a class="headerlink" href="#clustered-standard-errors" title="Permalink to this headline">#</a></h4>
<p>Often, we know something about the structure of likely errors, namely that they occur in groups. In the below example we use one-way clusters to capture this effect in the errors.</p>
<p>Note that in the below example, we grab a subset of the data for which a set of variables we’re interested in are defined, otherwise the below example would execute with an error because of missing cluster-group values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;homeworld&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">])</span>
<span class="n">results_clus</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xf</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">xf</span><span class="p">[</span><span class="s2">&quot;homeworld&quot;</span><span class="p">]}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_clus</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                   mass   R-squared:                       0.014
Model:                            OLS   Adj. R-squared:                 -0.005
Method:                 Least Squares   F-statistic:                     39.44
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           2.63e-07
Time:                        00:42:46   Log-Likelihood:                -361.23
No. Observations:                  55   AIC:                             726.5
Df Residuals:                      53   BIC:                             730.5
Df Model:                           1                                         
Covariance Type:              cluster                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -8.7955     29.150     -0.302      0.763     -65.929      48.338
height         0.6159      0.098      6.280      0.000       0.424       0.808
==============================================================================
Omnibus:                      121.086   Durbin-Watson:                   2.029
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             5943.317
Skew:                           7.095   Prob(JB):                         0.00
Kurtosis:                      51.909   Cond. No.                         958.
==============================================================================

Notes:
[1] Standard Errors are robust to cluster correlation (cluster)
</pre></div>
</div>
</div>
</div>
<p>We can add two-way clustering of standard errors using the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;homeworld&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">])</span>
<span class="n">two_way_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xf</span><span class="p">[[</span><span class="s2">&quot;homeworld&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">results_clus</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mass ~ height&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xf</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">two_way_clusters</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_clus</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                   mass   R-squared:                       0.014
Model:                            OLS   Adj. R-squared:                 -0.005
Method:                 Least Squares   F-statistic:                     35.10
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           1.96e-06
Time:                        00:42:46   Log-Likelihood:                -361.23
No. Observations:                  55   AIC:                             726.5
Df Residuals:                      53   BIC:                             730.5
Df Model:                           1                                         
Covariance Type:              cluster                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -8.7955     30.636     -0.287      0.774     -68.841      51.250
height         0.6159      0.104      5.925      0.000       0.412       0.820
==============================================================================
Omnibus:                      121.086   Durbin-Watson:                   2.029
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             5943.317
Skew:                           7.095   Prob(JB):                         0.00
Kurtosis:                      51.909   Cond. No.                         958.
==============================================================================

Notes:
[1] Standard Errors are robust to cluster correlation (cluster)
</pre></div>
</div>
</div>
</div>
<p>As you would generally expect, the addition of clustering has increased the standard errors.</p>
</section>
</section>
</section>
<section id="fixed-effects-and-categorical-variables">
<h2>Fixed effects and categorical variables<a class="headerlink" href="#fixed-effects-and-categorical-variables" title="Permalink to this headline">#</a></h2>
<p>Fixed effects are a way of allowing the intercept of a regression model to vary freely across individuals or groups. It is, for example, used to control for any individual-specific attributes that do not vary across time in panel data.</p>
<p>Let’s use the ‘mtcars’ dataset to demonstrate this. We’ll read it in and set the datatypes of some of the columns at the same time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/LOST-STATS/lost-stats.github.io/source/Data/mtcars.csv&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;mpg&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;hp&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;cyl&quot;</span><span class="p">:</span> <span class="s2">&quot;category&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">mpg</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model</th>
      <th>mpg</th>
      <th>cyl</th>
      <th>disp</th>
      <th>hp</th>
      <th>drat</th>
      <th>wt</th>
      <th>qsec</th>
      <th>vs</th>
      <th>am</th>
      <th>gear</th>
      <th>carb</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Mazda RX4</td>
      <td>21.0</td>
      <td>6</td>
      <td>160.0</td>
      <td>110.0</td>
      <td>3.90</td>
      <td>2.620</td>
      <td>16.46</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mazda RX4 Wag</td>
      <td>21.0</td>
      <td>6</td>
      <td>160.0</td>
      <td>110.0</td>
      <td>3.90</td>
      <td>2.875</td>
      <td>17.02</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Datsun 710</td>
      <td>22.8</td>
      <td>4</td>
      <td>108.0</td>
      <td>93.0</td>
      <td>3.85</td>
      <td>2.320</td>
      <td>18.61</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Hornet 4 Drive</td>
      <td>21.4</td>
      <td>6</td>
      <td>258.0</td>
      <td>110.0</td>
      <td>3.08</td>
      <td>3.215</td>
      <td>19.44</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Hornet Sportabout</td>
      <td>18.7</td>
      <td>8</td>
      <td>360.0</td>
      <td>175.0</td>
      <td>3.15</td>
      <td>3.440</td>
      <td>17.02</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we have our data in we want to regress mpg (miles per gallon) on hp (horsepower) with fixed effects for cyl (cylinders). Now we <em>could</em> just pop in a formula like this <code class="docutils literal notranslate"><span class="pre">'mpg</span> <span class="pre">~</span> <span class="pre">hp</span> <span class="pre">+</span> <span class="pre">cyl'</span></code> because we took the trouble to declare that <code class="docutils literal notranslate"><span class="pre">cyl</span></code> was of datatype category when reading it in from the csv file. This means that statsmodels will treat it as a category and use it as a fixed effect by default.</p>
<p>But when I read that formula I get nervous that <code class="docutils literal notranslate"><span class="pre">cyl</span></code> might not have been processed correctly (ie it could have been read in as a float, which is what it looks like) and it might just be treated as a float (aka a continuous variable) in the regression. Which is not what we want at all. So, to be safe, and make our intentions explicit (even when the data is of type ‘category’), it’s best to use the syntax <code class="docutils literal notranslate"><span class="pre">C(cyl)</span></code> to ask for a fixed effect.</p>
<p>Here’s a regression which does that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_fe</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp + C(cyl)&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_fe</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                    mpg   R-squared:                       0.754
Model:                            OLS   Adj. R-squared:                  0.727
Method:                 Least Squares   F-statistic:                     28.59
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           1.14e-08
Time:                        00:42:46   Log-Likelihood:                -79.948
No. Observations:                  32   AIC:                             167.9
Df Residuals:                      28   BIC:                             173.8
Df Model:                           3                                         
Covariance Type:            nonrobust                                         
===============================================================================
                  coef    std err          t      P&gt;|t|      [0.025      0.975]
-------------------------------------------------------------------------------
Intercept      28.6501      1.588     18.044      0.000      25.398      31.903
C(cyl)[T.6]    -5.9677      1.639     -3.640      0.001      -9.326      -2.610
C(cyl)[T.8]    -8.5209      2.326     -3.663      0.001     -13.286      -3.756
hp             -0.0240      0.015     -1.560      0.130      -0.056       0.008
==============================================================================
Omnibus:                        0.251   Durbin-Watson:                   1.667
Prob(Omnibus):                  0.882   Jarque-Bera (JB):                0.417
Skew:                           0.163   Prob(JB):                        0.812
Kurtosis:                       2.545   Cond. No.                         766.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<p>We can see here that two of the three possible values of <code class="docutils literal notranslate"><span class="pre">cyl</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpg</span><span class="p">[</span><span class="s2">&quot;cyl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;6&#39;, &#39;4&#39;, &#39;8&#39;]
Categories (3, object): [&#39;4&#39;, &#39;6&#39;, &#39;8&#39;]
</pre></div>
</div>
</div>
</div>
<p>have been added as fixed effects regressors. The way that <code class="docutils literal notranslate"><span class="pre">+C(cyl)</span></code> has been added makes it so that the coefficients given are relative to the coefficient for the intercept. We can turn the intercept off to get a coefficient per unique <code class="docutils literal notranslate"><span class="pre">cyl</span></code> value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp + C(cyl) -1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
C(cyl)[4]     28.6501      1.588     18.044      0.000      25.398      31.903
C(cyl)[6]     22.6825      2.228     10.180      0.000      18.119      27.246
C(cyl)[8]     20.1293      3.331      6.042      0.000      13.305      26.953
hp            -0.0240      0.015     -1.560      0.130      -0.056       0.008
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>When there is an intercept, the coefficients of fixed effect variables can be interpreted as being the average of <span class="math notranslate nohighlight">\(y\)</span> for that class <em>compared</em> to the excluded classes holding all other categories and variables fixed.</p>
<section id="high-dimensional-fixed-effects-aka-absorbing-regression">
<h3>High dimensional fixed effects, aka absorbing regression<a class="headerlink" href="#high-dimensional-fixed-effects-aka-absorbing-regression" title="Permalink to this headline">#</a></h3>
<p>Sometimes, you just have a LOT of fixed effects (and perhaps you don’t particularly care about them individually). A common example is having a large number of firms as part of a panel. Fortunately, there are ways to make regression with high dimensional fixed effects be both fast and concise. (In Stata, this is provided by the <code class="docutils literal notranslate"><span class="pre">reghdfe</span></code> package.) Here, we will use the <a class="reference external" href="https://bashtage.github.io/linearmodels/index.html"><strong>linearmodels</strong></a> package, which is built on top of <strong>statsmodels</strong>.</p>
<p>Let’s say we have a regression of the form</p>
<div class="math notranslate nohighlight">
\[
y_i = x_i\cdot \beta + z_i\cdot \gamma +\epsilon_i
\]</div>
<p>where <span class="math notranslate nohighlight">\(y_i\)</span> are observations indexed by <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(x_i\)</span> are vectors of exogenous variables we care about the coefficients (<span class="math notranslate nohighlight">\(\beta\)</span>), <span class="math notranslate nohighlight">\(z_i\)</span> are vectors of fixed effects we don’t care too much about the coefficients (\gamma) for, and the <span class="math notranslate nohighlight">\(\epsilon_i\)</span> are errors. Then we can use an <em>absorbing regression</em> to solve for the <span class="math notranslate nohighlight">\(\beta\)</span> while ignoring the <span class="math notranslate nohighlight">\(\gamma\)</span>.</p>
<p>Here’s an example using simulated data on workers taken from the <strong>linearmodels</strong> docs. Let’s simulate some data first, with two fixed effects (state and firm) alongside the two exogenous variables we’re interested in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>  <span class="c1"># Random number generator</span>

<span class="c1"># Create synthetic input data</span>
<span class="n">nobs</span> <span class="o">=</span> <span class="mi">1_000_000</span>  <span class="c1"># No. observations</span>
<span class="n">state_id</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>  <span class="c1"># State identifier</span>
<span class="n">firm_id</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">nobs</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>  <span class="c1"># Firm identifier (mean of 5 workers/firm)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Exogenous variables</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;state_id&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">state_id</span><span class="p">),</span>
        <span class="s2">&quot;firm_id&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">firm_id</span><span class="p">),</span>
        <span class="s2">&quot;exog_0&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;exog_1&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Create synthetic relationship</span>
<span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># coefficients of interest</span>
<span class="n">state_effects</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">state_id</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">state_effects</span> <span class="o">=</span> <span class="n">state_effects</span><span class="p">[</span><span class="n">state_id</span><span class="p">]</span>  <span class="c1"># Generate state fixed effects</span>
<span class="n">firm_effects</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">firm_id</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">firm_effects</span> <span class="o">=</span> <span class="n">firm_effects</span><span class="p">[</span><span class="n">firm_id</span><span class="p">]</span>  <span class="c1"># Generate firm fixed effects</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span>  <span class="c1"># Generate errors</span>
<span class="c1"># Generate endogeneous outcome variable</span>
<span class="n">sim</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;exog_0&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;exog_1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">firm_effects</span>
    <span class="o">+</span> <span class="n">state_effects</span>
    <span class="o">+</span> <span class="n">eps</span>
<span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state_id</th>
      <th>firm_id</th>
      <th>exog_0</th>
      <th>exog_1</th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>109981</td>
      <td>0.231898</td>
      <td>0.227373</td>
      <td>-0.330146</td>
    </tr>
    <tr>
      <th>1</th>
      <td>16</td>
      <td>143756</td>
      <td>-0.826250</td>
      <td>-0.907279</td>
      <td>-6.369599</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36</td>
      <td>178960</td>
      <td>-1.927288</td>
      <td>-2.205871</td>
      <td>-9.504071</td>
    </tr>
    <tr>
      <th>3</th>
      <td>25</td>
      <td>6654</td>
      <td>-0.291475</td>
      <td>0.711902</td>
      <td>0.364891</td>
    </tr>
    <tr>
      <th>4</th>
      <td>26</td>
      <td>180110</td>
      <td>0.653378</td>
      <td>-0.146633</td>
      <td>2.239330</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we pass this to <strong>linearmodels</strong> and with the <code class="docutils literal notranslate"><span class="pre">state_id</span></code> and <code class="docutils literal notranslate"><span class="pre">firm_id</span></code> variables entered via the <code class="docutils literal notranslate"><span class="pre">absorb</span></code> keyword argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linearmodels.iv.absorbing</span> <span class="kn">import</span> <span class="n">AbsorbingLS</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">AbsorbingLS</span><span class="p">(</span>
    <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">sim</span><span class="p">[[</span><span class="s2">&quot;exog_0&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_1&quot;</span><span class="p">]],</span> <span class="n">absorb</span><span class="o">=</span><span class="n">sim</span><span class="p">[[</span><span class="s2">&quot;state_id&quot;</span><span class="p">,</span> <span class="s2">&quot;firm_id&quot;</span><span class="p">]]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/envs/codeforecon/lib/python3.8/site-packages/linearmodels/iv/absorbing.py:710: FutureWarning: In a future version of pandas all arguments of DataFrame.any and Series.any will be keyword-only.
  missing |= self._absorb_inter.cat.isnull().any(1).to_numpy()
/opt/anaconda3/envs/codeforecon/lib/python3.8/site-packages/linearmodels/iv/absorbing.py:711: FutureWarning: In a future version of pandas all arguments of DataFrame.any and Series.any will be keyword-only.
  missing |= self._absorb_inter.cont.isnull().any(1).to_numpy()
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                         Absorbing LS Estimation Summary                          
==================================================================================
Dep. Variable:                      y   R-squared:                          0.9369
Estimator:               Absorbing LS   Adj. R-squared:                     0.9213
No. Observations:             1000000   F-statistic:                     9.808e+06
Date:                Wed, Feb 01 2023   P-value (F-stat):                   0.0000
Time:                        00:42:51   Distribution:                      chi2(2)
Cov. Estimator:                robust   R-squared (No Effects):             0.9091
                                        Varaibles Absorbed:              1.987e+05
                             Parameter Estimates                              
==============================================================================
            Parameter  Std. Err.     T-stat    P-value    Lower CI    Upper CI
------------------------------------------------------------------------------
exog_0         0.9995     0.0010     988.51     0.0000      0.9975      1.0014
exog_1         2.9988     0.0010     2972.2     0.0000      2.9969      3.0008
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>So, from our 1,000,000 observations, we have roughly 200,000 fixed effects that have been scooped up and packed away, leaving us with just the coefficients, <span class="math notranslate nohighlight">\(\beta\)</span>, on the exogenous variables of interest.</p>
</section>
</section>
<section id="transformations-of-regressors">
<h2>Transformations of regressors<a class="headerlink" href="#transformations-of-regressors" title="Permalink to this headline">#</a></h2>
<p>This chapter is showcasing <em>linear</em> regression. What that means is that the model is linear in the regressors: but it doesn’t mean that those regressors can’t be some kind of (potentially non-linear) transform of the original features <span class="math notranslate nohighlight">\(x_i\)</span>.</p>
<section id="logs-and-arcsinh">
<h3>Logs and arcsinh<a class="headerlink" href="#logs-and-arcsinh" title="Permalink to this headline">#</a></h3>
<p>You have two options for adding in logs: do them before, or do them in the formula. Doing them before just makes use of standard dataframe operations to declare a new column:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpg</span><span class="p">[</span><span class="s2">&quot;lnhp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mpg</span><span class="p">[</span><span class="s2">&quot;hp&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ lnhp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     72.6405      6.004     12.098      0.000      60.378      84.903
lnhp         -10.7642      1.224     -8.792      0.000     -13.265      -8.264
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>Alternatively, you can specify the log directly in the formula:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_ln</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ np.log(hp)&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_ln</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     72.6405      6.004     12.098      0.000      60.378      84.903
np.log(hp)   -10.7642      1.224     -8.792      0.000     -13.265      -8.264
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>Clearly, the first method will work for <code class="docutils literal notranslate"><span class="pre">arcsinh(x)</span></code> and <code class="docutils literal notranslate"><span class="pre">log(x+1)</span></code>, but you can also pass both of these into the formula directly too. (For more on the pros and cons of arcsinh, see <span id="id2">Bellemare and Wichman [<a class="reference internal" href="zreferences.html#id6" title="Marc F Bellemare and Casey J Wichman. Elasticities and the inverse hyperbolic sine transformation. Oxford Bulletin of Economics and Statistics, 82(1):50–61, 2020.">2020</a>]</span>.) Here it is with arcsinh:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ np.arcsinh(hp)&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================================================
                     coef    std err          t      P&gt;|t|      [0.025      0.975]
----------------------------------------------------------------------------------
Intercept         80.1041      6.850     11.694      0.000      66.115      94.094
np.arcsinh(hp)   -10.7646      1.224     -8.792      0.000     -13.265      -8.264
==================================================================================
</pre></div>
</div>
</div>
</div>
</section>
<section id="interaction-terms-and-powers">
<h3>Interaction terms and powers<a class="headerlink" href="#interaction-terms-and-powers" title="Permalink to this headline">#</a></h3>
<p>This chapter is showcasing <em>linear</em> regression. What that means is that the model is linear in the regressors: but it doesn’t mean that those regressors can’t be some kind of non-linear transform of the original features <span class="math notranslate nohighlight">\(x_i\)</span>. Two of the most common transformations that you might want to use are <em>interaction terms</em> and <em>polynomial terms</em>. An example of an interaction term would be</p>
<div class="math notranslate nohighlight">
\[
y = \beta_0 + \beta_1 x_1 \cdot x_2
\]</div>
<p>while an example of a polynomial term would be</p>
<div class="math notranslate nohighlight">
\[
y = \beta_0 + \beta_1 x_1^2
\]</div>
<p>i.e. the last term enters only after it is multiplied by itself.</p>
<p>One note of warning: the interpretation of the effect of a variable is no longer as simple as was set out at the start of this chapter. To work out <em>what</em> the new interpretation is, the procedure is the same though: just take the derivative. In the case of the interaction model above, the effect of a unit change in <span class="math notranslate nohighlight">\(x_1\)</span> on <span class="math notranslate nohighlight">\(y\)</span> is now going to be a function of <span class="math notranslate nohighlight">\(x_2\)</span>. In the case of the polynomial model above, the effect of a unit change in <span class="math notranslate nohighlight">\(x_1\)</span> on <span class="math notranslate nohighlight">\(y\)</span> will be <span class="math notranslate nohighlight">\(2\beta_1 \cdot x_1\)</span>. For more on interaction terms, see <span id="id3">Balli and Sørensen [<a class="reference internal" href="zreferences.html#id7" title="Hatice Ozer Balli and Bent E Sørensen. Interaction effects in econometrics. Empirical Economics, 45(1):583–603, 2013.">2013</a>]</span>.</p>
<p>Alright, with all of that preamble out of the way, let’s see how we actual do some of this! Let’s try including a linear and squared term in the regression of <code class="docutils literal notranslate"><span class="pre">mpg</span></code> on <code class="docutils literal notranslate"><span class="pre">hp</span></code> making use of the numpy power function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_poly</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp + np.power(hp, 2)&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_poly</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===================================================================================
                      coef    std err          t      P&gt;|t|      [0.025      0.975]
-----------------------------------------------------------------------------------
Intercept          40.4091      2.741     14.744      0.000      34.804      46.015
hp                 -0.2133      0.035     -6.115      0.000      -0.285      -0.142
np.power(hp, 2)     0.0004   9.84e-05      4.275      0.000       0.000       0.001
===================================================================================
</pre></div>
</div>
</div>
</div>
<p>Now let’s include the original term in hp, a term in disp, and the interaction between them, which is represented by hp:disp in the table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_inter</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp * disp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_inter</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     39.6743      2.914     13.614      0.000      33.705      45.644
hp            -0.0979      0.025     -3.956      0.000      -0.149      -0.047
disp          -0.0734      0.014     -5.100      0.000      -0.103      -0.044
hp:disp        0.0003   8.69e-05      3.336      0.002       0.000       0.000
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>In the unusual case that you want <em>only</em> the interaction term, you write it as it appears in the table above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp : disp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mpg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     25.8099      1.005     25.677      0.000      23.757      27.863
hp:disp       -0.0001   1.91e-05     -7.409      0.000      -0.000      -0.000
==============================================================================
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="the-formula-api-explained">
<h2>The formula API explained<a class="headerlink" href="#the-formula-api-explained" title="Permalink to this headline">#</a></h2>
<p>As you will have seen <code class="docutils literal notranslate"><span class="pre">~</span></code> separates the left- and right-hand sides of the regression. <code class="docutils literal notranslate"><span class="pre">+</span></code> computes a set union, which will also be familiar from the examples above (ie it inludes two terms as long as they are distinct). <code class="docutils literal notranslate"><span class="pre">-</span></code> computes a set difference; it adds the set of terms to the left of it while removing any that appear on the right of it. As we’ve seen, <code class="docutils literal notranslate"><span class="pre">a*b</span></code> is a short-hand for <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">a:b</span></code>, with the last term representing the interaction. <code class="docutils literal notranslate"><span class="pre">/</span></code> is short hand for <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">a:b</span></code>, which is useful if, for example <code class="docutils literal notranslate"><span class="pre">b</span></code> is nested within <code class="docutils literal notranslate"><span class="pre">a</span></code>, so it doesn’t make sense to control for <code class="docutils literal notranslate"><span class="pre">b</span></code> on its own. Actually, the <code class="docutils literal notranslate"><span class="pre">:</span></code> character can interact multiple terms so that <code class="docutils literal notranslate"><span class="pre">(a</span> <span class="pre">+</span> <span class="pre">b):(d</span> <span class="pre">+</span> <span class="pre">c)</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">a:c</span> <span class="pre">+</span> <span class="pre">a:d</span> <span class="pre">+</span> <span class="pre">b:c</span> <span class="pre">+</span> <span class="pre">b:d</span></code>. <code class="docutils literal notranslate"><span class="pre">C(a)</span></code> tells statsmodels to treat <code class="docutils literal notranslate"><span class="pre">a</span></code> as a categorical variable that will be included as a fixed effect. Finally, as we saw above with powers, you can also pass in vectorised functions, such as <code class="docutils literal notranslate"><span class="pre">np.log</span></code> and <code class="docutils literal notranslate"><span class="pre">np.power</span></code>, directly into the formulae.</p>
<p>One gotcha with the formula API is ensuring that you have sensible variable names in your dataframe, i.e. ones that do <em>not</em> include whitespace or, to take a really pathological example, have the name ‘a + b’ for one of the columns that you want to regress on. You can dodge this kind of problem by passing in the variable name as, for example, <code class="docutils literal notranslate"><span class="pre">Q(&quot;a</span> <span class="pre">+</span> <span class="pre">b&quot;)</span></code> to be clear that the <em>column name</em> is anything within the <code class="docutils literal notranslate"><span class="pre">Q(&quot;...&quot;)</span></code>.</p>
</section>
<section id="multiple-regression-models">
<h2>Multiple regression models<a class="headerlink" href="#multiple-regression-models" title="Permalink to this headline">#</a></h2>
<p>As is so often the case, you’re likely to want to run more than one model at once with different specifications. Although there is a base version of this in <strong>statsmodels</strong>, called <code class="docutils literal notranslate"><span class="pre">summary_col</span></code>, which you can find an example of <a class="reference external" href="http://aeturrell.com//2018/05/05/running-many-regressions-alongside-pandas/">here</a>, instead we’ll be using the <a class="reference external" href="https://github.com/mwburke/stargazer"><strong>stargazer</strong></a> package to assemble the regressions together in a table.</p>
<p>In the above examples, we’ve collected a few different regression results. Let’s put them together:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">stargazer.stargazer</span> <span class="kn">import</span> <span class="n">Stargazer</span>


<span class="n">stargazer_tab</span> <span class="o">=</span> <span class="n">Stargazer</span><span class="p">([</span><span class="n">results_ln</span><span class="p">,</span> <span class="n">res_poly</span><span class="p">,</span> <span class="n">res_inter</span><span class="p">])</span>
<span class="n">stargazer_tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="text-align:center"><tr><td colspan="4" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"></td><td colspan="3"><em>Dependent variable:mpg</em></td></tr><tr><td style="text-align:left"></td><tr><td style="text-align:left"></td><td>(1)</td><td>(2)</td><td>(3)</td></tr><tr><td colspan="4" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">Intercept</td><td>72.640<sup>***</sup></td><td>40.409<sup>***</sup></td><td>39.674<sup>***</sup></td></tr><tr><td style="text-align:left"></td><td>(6.004)</td><td>(2.741)</td><td>(2.914)</td></tr><tr><td style="text-align:left">disp</td><td></td><td></td><td>-0.073<sup>***</sup></td></tr><tr><td style="text-align:left"></td><td></td><td></td><td>(0.014)</td></tr><tr><td style="text-align:left">hp</td><td></td><td>-0.213<sup>***</sup></td><td>-0.098<sup>***</sup></td></tr><tr><td style="text-align:left"></td><td></td><td>(0.035)</td><td>(0.025)</td></tr><tr><td style="text-align:left">hp:disp</td><td></td><td></td><td>0.000<sup>***</sup></td></tr><tr><td style="text-align:left"></td><td></td><td></td><td>(0.000)</td></tr><tr><td style="text-align:left">np.log(hp)</td><td>-10.764<sup>***</sup></td><td></td><td></td></tr><tr><td style="text-align:left"></td><td>(1.224)</td><td></td><td></td></tr><tr><td style="text-align:left">np.power(hp, 2)</td><td></td><td>0.000<sup>***</sup></td><td></td></tr><tr><td style="text-align:left"></td><td></td><td>(0.000)</td><td></td></tr><td colspan="4" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align: left">Observations</td><td>32</td><td>32</td><td>32</td></tr><tr><td style="text-align: left">R<sup>2</sup></td><td>0.720</td><td>0.756</td><td>0.820</td></tr><tr><td style="text-align: left">Adjusted R<sup>2</sup></td><td>0.711</td><td>0.739</td><td>0.801</td></tr><tr><td style="text-align: left">Residual Std. Error</td><td>3.239 (df=30)</td><td>3.077 (df=29)</td><td>2.692 (df=28)</td></tr><tr><td style="text-align: left">F Statistic</td><td>77.301<sup>***</sup> (df=1; 30)</td><td>44.953<sup>***</sup> (df=2; 29)</td><td>42.475<sup>***</sup> (df=3; 28)</td></tr><tr><td colspan="4" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align: left">Note:</td>
 <td colspan="3" style="text-align: right">
  <sup>*</sup>p&lt;0.1;
  <sup>**</sup>p&lt;0.05;
  <sup>***</sup>p&lt;0.01
 </td></tr></table></div></div>
</div>
<p>There are lots of customisation options, including ones that add a title, rename variables, add notes, and so on. What is most useful is that as well as the HTML friendly output that you can see above, the package also exports to latex:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">stargazer_tab</span><span class="o">.</span><span class="n">render_latex</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>\begin{table}[!htbp] \centering
\begin{tabular}{@{\extracolsep{5pt}}lccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
&amp; \multicolumn{3}{c}{\textit{Dependent variable:}} \
\cr \cline{3-4}
\\[-1.8ex] &amp; (1) &amp; (2) &amp; (3) \\
\hline \\[-1.8ex]
 Intercept &amp; 72.640$^{***}$ &amp; 40.409$^{***}$ &amp; 39.674$^{***}$ \\
  &amp; (6.004) &amp; (2.741) &amp; (2.914) \\
 disp &amp; &amp; &amp; -0.073$^{***}$ \\
  &amp; &amp; &amp; (0.014) \\
 hp &amp; &amp; -0.213$^{***}$ &amp; -0.098$^{***}$ \\
  &amp; &amp; (0.035) &amp; (0.025) \\
 hp:disp &amp; &amp; &amp; 0.000$^{***}$ \\
  &amp; &amp; &amp; (0.000) \\
 np.log(hp) &amp; -10.764$^{***}$ &amp; &amp; \\
  &amp; (1.224) &amp; &amp; \\
 np.power(hp, 2) &amp; &amp; 0.000$^{***}$ &amp; \\
  &amp; &amp; (0.000) &amp; \\
\hline \\[-1.8ex]
 Observations &amp; 32 &amp; 32 &amp; 32 \\
 $R^2$ &amp; 0.720 &amp; 0.756 &amp; 0.820 \\
 Adjusted $R^2$ &amp; 0.711 &amp; 0.739 &amp; 0.801 \\
 Residual Std. Error &amp; 3.239(df = 30) &amp; 3.077(df = 29) &amp; 2.692(df = 28)  \\
 F Statistic &amp; 77.301$^{***}$ (df = 1.0; 30.0) &amp; 44.953$^{***}$ (df = 2.0; 29.0) &amp; 42.475$^{***}$ (df = 3.0; 28.0) \\
\hline
\hline \\[-1.8ex]
\textit{Note:} &amp; \multicolumn{3}{r}{$^{*}$p$&lt;$0.1; $^{**}$p$&lt;$0.05; $^{***}$p$&lt;$0.01} \\
\end{tabular}
\end{table}
</pre></div>
</div>
</div>
</div>
<p>And of course this can be written to a file using <code class="docutils literal notranslate"><span class="pre">open('regression.tex',</span> <span class="pre">'w').write(stargazer.render_latex())</span></code> where you can get your main latex compilation to scoop it up and use it.</p>
</section>
<section id="specifying-regressions-without-formulae-using-the-array-api">
<h2>Specifying regressions without formulae, using the array API<a class="headerlink" href="#specifying-regressions-without-formulae-using-the-array-api" title="Permalink to this headline">#</a></h2>
<p>As noted, there are two ways to run regressions in <a class="reference external" href="https://www.statsmodels.org/stable/index.html"><strong>statsmodels</strong></a>; passing the data directly as objects, and using formulae. We’ve seen the formula API, now let’s see how to specify regressions using arrays with the format <code class="docutils literal notranslate"><span class="pre">sm.OLS(y,</span> <span class="pre">X)</span></code>.</p>
<p>We will first need to take the data out of the <strong>pandas</strong> dataframe and put it into a couple of arrays. When we’re not using the formula API, the default is to treat the array X as the design matrix for the regression-so, if it doesn’t have a column of constants in, there will be no intercept in the regression. Therefore, we need to add a constant vector to the matrix <code class="docutils literal notranslate"><span class="pre">X</span></code> if we <em>do</em> want an intercept. Use <code class="docutils literal notranslate"><span class="pre">sm.add_constant(X)</span></code> for this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xf</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xf</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.014
Model:                            OLS   Adj. R-squared:                 -0.005
Method:                 Least Squares   F-statistic:                    0.7446
Date:                Wed, 01 Feb 2023   Prob (F-statistic):              0.392
Time:                        00:42:51   Log-Likelihood:                -361.23
No. Observations:                  55   AIC:                             726.5
Df Residuals:                      53   BIC:                             730.5
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -8.7955    127.191     -0.069      0.945    -263.909     246.318
x1             0.6159      0.714      0.863      0.392      -0.816       2.048
==============================================================================
Omnibus:                      121.086   Durbin-Watson:                   2.029
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             5943.317
Skew:                           7.095   Prob(JB):                         0.00
Kurtosis:                      51.909   Cond. No.                         958.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<p>This approach seems a lot less convenient, not to mention less clear, so you may be wondering when it is useful. It’s useful when you want to do many regressions in a systematic way or when you don’t know what the columns of a dataset will be called ahead of time. It can actually be a little bit simpler to specify for more complex regressions too.</p>
<section id="fixed-effects-in-the-array-api">
<h3>Fixed effects in the array API<a class="headerlink" href="#fixed-effects-in-the-array-api" title="Permalink to this headline">#</a></h3>
<p>If you’re using the formula API, it’s easy to turn a regressor <code class="docutils literal notranslate"><span class="pre">x</span></code> into a fixed effect by putting <code class="docutils literal notranslate"><span class="pre">C(x)</span></code> into the model formula, as you’ll see in the next section.</p>
<p>For the array API, things are not that simple and you need to use dummy variables. Let’s say we have some data like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set seed for random numbers</span>
<span class="n">seed_for_prng</span> <span class="o">=</span> <span class="mi">78557</span>
<span class="n">prng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed_for_prng</span><span class="p">)</span>  <span class="c1"># prng=probabilistic random number generator</span>

<span class="n">no_obs</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">no_obs</span><span class="p">))</span>
<span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">no_obs</span><span class="p">)</span>
<span class="c1"># Get this a numpy array</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># Create the y data, adding in a bit of noise</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">prng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">no_obs</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">el_y</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">el_x</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span> <span class="k">else</span> <span class="n">el_y</span> <span class="o">+</span> <span class="mf">3.4</span> <span class="k">for</span> <span class="n">el_y</span><span class="p">,</span> <span class="n">el_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])]</span>
<span class="n">X</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.927388713624307, &#39;b&#39;],
       [-0.05975401040013389, &#39;a&#39;],
       [1.0437358922863453, &#39;a&#39;],
       [1.5056188793532617, &#39;b&#39;],
       [0.10762743224577262, &#39;a&#39;]], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>The first feature (column) is of numbers and it’s clear how we include it. The second, however, is a grouping that we’d like to include as a fixed effect. But if we just throw this matrix into <code class="docutils literal notranslate"><span class="pre">sm.OLS(y,</span> <span class="pre">X)</span></code>, we’re going to get trouble because <strong>statsmodels</strong> isn’t sure what to do with a vector of strings. So, instead, we need to create some dummy variables out of our second column of data</p>
<p>Astonishingly, there are several popular ways to create dummy variables in Python: <strong>scikit-learn</strong>’s <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code> and <strong>pandas</strong>’ <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> being my favourites. Let’s use the latter here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>197</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>198</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>199</th>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>200 rows × 2 columns</p>
</div></div></div>
</div>
<p>We just need to pop this into our matrix <span class="math notranslate nohighlight">\(X\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">X</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.92738871,  0.        ,  1.        ],
       [-0.05975401,  1.        ,  0.        ],
       [ 1.04373589,  1.        ,  0.        ],
       [ 1.50561888,  0.        ,  1.        ],
       [ 0.10762743,  1.        ,  0.        ]])
</pre></div>
</div>
</div>
</div>
<p>Okay, so now we’re ready to do our regression:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.998
Model:                            OLS   Adj. R-squared:                  0.998
Method:                 Least Squares   F-statistic:                 4.302e+04
Date:                Wed, 01 Feb 2023   Prob (F-statistic):          6.90e-261
Time:                        00:42:51   Log-Likelihood:                 165.45
No. Observations:                 200   AIC:                            -324.9
Df Residuals:                     197   BIC:                            -315.0
Df Model:                           2                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
x1             1.9893      0.008    263.045      0.000       1.974       2.004
x2             1.9924      0.011    176.203      0.000       1.970       2.015
x3             3.8977      0.010    384.415      0.000       3.878       3.918
==============================================================================
Omnibus:                        2.096   Durbin-Watson:                   2.116
Prob(Omnibus):                  0.351   Jarque-Bera (JB):                2.017
Skew:                           0.245   Prob(JB):                        0.365
Kurtosis:                       2.955   Cond. No.                         1.50
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<p>Perhaps you can see why I generally prefer the formula API…</p>
</section>
</section>
<section id="instrumental-variables">
<h2>Instrumental variables<a class="headerlink" href="#instrumental-variables" title="Permalink to this headline">#</a></h2>
<p>Rather than use <strong>statsmodels</strong> for IV, we’ll use the <a class="reference external" href="https://bashtage.github.io/linearmodels/doc/index.html"><strong>linearmodels</strong></a> package, which has very clean documentation (indeed, this sub-section is indebted to that documentation).</p>
<p>Recall that a good instrumental variable <span class="math notranslate nohighlight">\(z\)</span> has zero covariance with the error from the regression (which is untestable) and non-zero covariance with the variable of interest (which is).</p>
<p>Recall that in IV regression, we have a model of the form</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}y_i    &amp; = x_{1i}\hat{\beta_1} + x_{2i}\hat{\beta_2} + \epsilon_i \\
x_{2i} &amp; = z_{1i}\hat{\delta} + z_{2i}\hat{\gamma} + \nu_i\end{split}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(x_{1i}\)</span> is a set of <span class="math notranslate nohighlight">\(k_1\)</span> exogenous regressors and <span class="math notranslate nohighlight">\(x_{2i}\)</span> is a set of <span class="math notranslate nohighlight">\(k_2\)</span> endogenous regressors such that <span class="math notranslate nohighlight">\(\text{Cov}(x_{2i}, \epsilon_i)\neq 0\)</span>. This is a problem for the usual OLS assumptions (the right-hand side should be exogenous).</p>
<p>To get around this, in 2-stage least squares IV, we first regress <span class="math notranslate nohighlight">\(x_{2i}\)</span> on instruments that explain <span class="math notranslate nohighlight">\(x_{2i}\)</span> <em>but not</em> <span class="math notranslate nohighlight">\(y_i\)</span>, and then regress <span class="math notranslate nohighlight">\(y_i\)</span> only on the predicted/estimated left-hand side from the first regression, ie on <span class="math notranslate nohighlight">\(\hat{x_{2i}}\)</span>. There are other estimators than IV2SLS, but I think that one has the most intuitive explanation of what’s going.</p>
<p>As well as a 2-stage least squares estimator called <code class="docutils literal notranslate"><span class="pre">IV2SLS</span></code>, <strong>linearmodels</strong> has a Limited Information Maximum Likelihood (LIML) estimator <code class="docutils literal notranslate"><span class="pre">IVLIML</span></code>, a Generalized Method of Moments (GMM) estimator <code class="docutils literal notranslate"><span class="pre">IVGMM</span></code>, and a Generalized Method of Moments using the Continuously Updating Estimator (CUE) <code class="docutils literal notranslate"><span class="pre">IVGMMCUE</span></code>.</p>
<p>Just as with OLS via <strong>statsmodels</strong>, there’s an option to use an array API for the <strong>linearmodels</strong> IV methods.</p>
<p>It’s always easiest to see an example, so let’s estimate what might cause (realised) cigarette demand for the 48 continental US states in 1995 with <code class="docutils literal notranslate"><span class="pre">IV2SLS</span></code>. First we need to import the estimator, <code class="docutils literal notranslate"><span class="pre">IV2SLS</span></code>, and the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linearmodels.iv</span> <span class="kn">import</span> <span class="n">IV2SLS</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://vincentarelbundock.github.io/Rdatasets/csv/AER/CigarettesSW.csv&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;category&quot;</span><span class="p">},</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">rprice</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;cpi&quot;</span><span class="p">],</span>
    <span class="n">rincome</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;cpi&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>state</th>
      <th>year</th>
      <th>cpi</th>
      <th>population</th>
      <th>packs</th>
      <th>income</th>
      <th>tax</th>
      <th>price</th>
      <th>taxs</th>
      <th>rprice</th>
      <th>rincome</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>AL</td>
      <td>1985</td>
      <td>1.076</td>
      <td>3973000.0</td>
      <td>116.486282</td>
      <td>46014968</td>
      <td>32.500004</td>
      <td>102.181671</td>
      <td>33.348335</td>
      <td>94.964381</td>
      <td>10.763866</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>AR</td>
      <td>1985</td>
      <td>1.076</td>
      <td>2327000.0</td>
      <td>128.534592</td>
      <td>26210736</td>
      <td>37.000000</td>
      <td>101.474998</td>
      <td>37.000000</td>
      <td>94.307622</td>
      <td>10.468165</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>AZ</td>
      <td>1985</td>
      <td>1.076</td>
      <td>3184000.0</td>
      <td>104.522614</td>
      <td>43956936</td>
      <td>31.000000</td>
      <td>108.578751</td>
      <td>36.170418</td>
      <td>100.909622</td>
      <td>12.830456</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>CA</td>
      <td>1985</td>
      <td>1.076</td>
      <td>26444000.0</td>
      <td>100.363037</td>
      <td>447102816</td>
      <td>26.000000</td>
      <td>107.837341</td>
      <td>32.104000</td>
      <td>100.220580</td>
      <td>15.713321</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>CO</td>
      <td>1985</td>
      <td>1.076</td>
      <td>3209000.0</td>
      <td>112.963539</td>
      <td>49466672</td>
      <td>31.000000</td>
      <td>94.266663</td>
      <td>31.000000</td>
      <td>87.608425</td>
      <td>14.326190</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we’ll specify the model. It’s going to be in the form <code class="docutils literal notranslate"><span class="pre">dep</span> <span class="pre">~</span> <span class="pre">exog</span> <span class="pre">+</span> <span class="pre">[endog</span> <span class="pre">~</span> <span class="pre">instruments]</span></code>, where endog will be regressed on instruments and dep will be regressed on both exog and the predicted values of endog.</p>
<p>In this case, the model will be</p>
<div class="math notranslate nohighlight">
\[
\text{Price}_i = \hat{\pi_0} + \hat{\pi_1} \text{SalesTax}_i + v_i 
\]</div>
<p>in the first stage regression and</p>
<div class="math notranslate nohighlight">
\[
\text{Packs}_i = \hat{\beta_0} + \hat{\beta_2}\widehat{\text{Price}_i} + \hat{\beta_1} \text{RealIncome}_i + u_i
\]</div>
<p>in the second stage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_iv2sls</span> <span class="o">=</span> <span class="n">IV2SLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
    <span class="s2">&quot;np.log(packs) ~ 1 + np.log(rincome) + C(year) + C(state) + [np.log(rprice) ~ taxs]&quot;</span><span class="p">,</span>
    <span class="n">df</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;clustered&quot;</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_iv2sls</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                          IV-2SLS Estimation Summary                          
==============================================================================
Dep. Variable:          np.log(packs)   R-squared:                      0.9659
Estimator:                    IV-2SLS   Adj. R-squared:                 0.9279
No. Observations:                  96   F-statistic:                -1.349e+16
Date:                Wed, Feb 01 2023   P-value (F-stat)                1.0000
Time:                        00:42:51   Distribution:                 chi2(50)
Cov. Estimator:             clustered                                         
                                                                              
                                Parameter Estimates                                
===================================================================================
                 Parameter  Std. Err.     T-stat    P-value    Lower CI    Upper CI
-----------------------------------------------------------------------------------
Intercept           9.4924     0.0263     360.24     0.0000      9.4407      9.5440
C(state)[T.AR]      0.1770     0.0531     3.3338     0.0009      0.0729      0.2810
C(state)[T.AZ]     -0.0899     0.0132    -6.8132     0.0000     -0.1158     -0.0640
C(state)[T.CA]     -0.2781     0.0214    -12.996     0.0000     -0.3200     -0.2361
C(state)[T.CO]     -0.2479     0.0090    -27.625     0.0000     -0.2655     -0.2303
C(state)[T.CT]     -0.0171     0.0196    -0.8720     0.3832     -0.0556      0.0213
C(state)[T.DE]      0.1110     0.0291     3.8105     0.0001      0.0539      0.1682
C(state)[T.FL]      0.0762     0.0142     5.3596     0.0000      0.0483      0.1041
C(state)[T.GA]     -0.0695     0.0251    -2.7706     0.0056     -0.1186     -0.0203
C(state)[T.IA]      0.0120     0.0739     0.1629     0.8706     -0.1328      0.1569
C(state)[T.ID]     -0.1272     0.0077    -16.597     0.0000     -0.1423     -0.1122
C(state)[T.IL]     -0.0339     0.0081    -4.1912     0.0000     -0.0497     -0.0180
C(state)[T.IN]      0.1198     0.0611     1.9609     0.0499   5.573e-05      0.2395
C(state)[T.KS]     -0.0910     0.0305    -2.9884     0.0028     -0.1507     -0.0313
C(state)[T.KY]      0.3525     0.0631     5.5906     0.0000      0.2289      0.4761
C(state)[T.LA]      0.1315     0.0104     12.664     0.0000      0.1112      0.1519
C(state)[T.MA]     -0.0403     0.0069    -5.8826     0.0000     -0.0538     -0.0269
C(state)[T.MD]     -0.2322     0.0239    -9.7376     0.0000     -0.2790     -0.1855
C(state)[T.ME]      0.2008     0.0574     3.5011     0.0005      0.0884      0.3133
C(state)[T.MI]      0.1268     0.0745     1.7009     0.0890     -0.0193      0.2728
C(state)[T.MN]      0.0568     0.0490     1.1595     0.2463     -0.0392      0.1529
C(state)[T.MO]      0.0640     0.0476     1.3454     0.1785     -0.0292      0.1572
C(state)[T.MS]      0.1501     0.0272     5.5267     0.0000      0.0969      0.2034
C(state)[T.MT]     -0.1522     0.0054    -28.250     0.0000     -0.1627     -0.1416
C(state)[T.NC]      0.0396     0.0191     2.0655     0.0389      0.0020      0.0771
C(state)[T.ND]     -0.0311     0.0399    -0.7787     0.4361     -0.1092      0.0471
C(state)[T.NE]     -0.0741     0.0375    -1.9765     0.0481     -0.1476     -0.0006
C(state)[T.NH]      0.3504     0.0315     11.114     0.0000      0.2886      0.4122
C(state)[T.NJ]     -0.0873  6.107e-05    -1429.3     0.0000     -0.0874     -0.0872
C(state)[T.NM]     -0.2858     0.0040    -71.049     0.0000     -0.2937     -0.2779
C(state)[T.NV]      0.1789     0.0259     6.9075     0.0000      0.1281      0.2296
C(state)[T.NY]     -0.0719     0.0032    -22.256     0.0000     -0.0782     -0.0655
C(state)[T.OH]      0.0325     0.0402     0.8088     0.4186     -0.0463      0.1114
C(state)[T.OK]      0.0946     0.0538     1.7572     0.0789     -0.0109      0.2000
C(state)[T.OR]     -0.0153     0.0673    -0.2269     0.8205     -0.1471      0.1166
C(state)[T.PA]     -0.0031     0.0006    -4.8401     0.0000     -0.0044     -0.0019
C(state)[T.RI]      0.1394     0.0921     1.5136     0.1301     -0.0411      0.3200
C(state)[T.SC]     -0.0212     0.0334    -0.6345     0.5257     -0.0866      0.0442
C(state)[T.SD]     -0.0675     0.0711    -0.9488     0.3427     -0.2069      0.0719
C(state)[T.TN]      0.1473     0.0470     3.1340     0.0017      0.0552      0.2394
C(state)[T.TX]     -0.0579     0.0136    -4.2560     0.0000     -0.0845     -0.0312
C(state)[T.UT]     -0.4899     0.0276    -17.776     0.0000     -0.5440     -0.4359
C(state)[T.VA]     -0.0559     0.0471    -1.1875     0.2350     -0.1482      0.0364
C(state)[T.VT]      0.2209     0.0467     4.7267     0.0000      0.1293      0.3125
C(state)[T.WA]      0.0064     0.0011     6.0151     0.0000      0.0043      0.0085
C(state)[T.WI]      0.0741     0.0590     1.2569     0.2088     -0.0415      0.1897
C(state)[T.WV]      0.1576     0.0582     2.7097     0.0067      0.0436      0.2716
C(state)[T.WY]     -0.0169     0.0590    -0.2858     0.7750     -0.1325      0.0988
C(year)[T.1995]    -0.0328  9.853e-09  -3.33e+06     0.0000     -0.0328     -0.0328
np.log(rincome)     0.4434                                                         
np.log(rprice)     -1.2793   1.73e-09 -7.397e+08     0.0000     -1.2793     -1.2793
===================================================================================

Endogenous: np.log(rprice)
Instruments: taxs
Clustered Covariance (One-Way)
Debiased: False
Num Clusters: 2
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/envs/codeforecon/lib/python3.8/site-packages/linearmodels/iv/results.py:180: RuntimeWarning: invalid value encountered in sqrt
  std_errors = sqrt(diag(self.cov))
</pre></div>
</div>
</div>
</div>
<p>We sort of skipped a step here and did everything all in one go. If we <em>did</em> want to know how our first stage regression went, we can just pass a formula to <code class="docutils literal notranslate"><span class="pre">IV2SLS</span></code> without the part in square brackets, <code class="docutils literal notranslate"><span class="pre">[...]</span></code>, and it will run regular OLS.</p>
<p>But, in this case, there’s an easier way: we can print out a set of handy 1st stage statistics from running the full model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results_iv2sls</span><span class="o">.</span><span class="n">first_stage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      First Stage Estimation Results     
=========================================
                           np.log(rprice)
-----------------------------------------
R-squared                          0.9760
Partial R-squared                  0.7070
Shea&#39;s R-squared                   0.7070
Partial F-statistic             6.353e+16
P-value (Partial F-stat)           0.0000
Partial F-stat Distn              chi2(1)
========================== ==============
Intercept                          4.4375
                                 (410.34)
C(state)[T.AR]                    -0.0190
                                (-3.5717)
C(state)[T.AZ]                     0.0552
                                 (20.534)
C(state)[T.CA]                     0.0969
                                 (5.3807)
C(state)[T.CO]                    -0.0044
                                (-0.1117)
C(state)[T.CT]                     0.1269
                                 (9.0641)
C(state)[T.DE]                     0.0254
                                 (7.9851)
C(state)[T.FL]                     0.0598
                                 (4.0067)
C(state)[T.GA]                    -0.0049
                                (-0.3455)
C(state)[T.IA]                     0.0135
                                 (0.5305)
C(state)[T.ID]                     0.0297
                                 (79.832)
C(state)[T.IL]                     0.0476
                                 (12.008)
C(state)[T.IN]                    -0.0460
                                (-76.127)
C(state)[T.KS]                    -0.0019
                                (-0.0855)
C(state)[T.KY]                    -0.0783
                                (-3.6663)
C(state)[T.LA]                     0.0298
                                 (2.6211)
C(state)[T.MA]                     0.0816
                                 (5.3671)
C(state)[T.MD]                    -0.0199
                                (-0.5429)
C(state)[T.ME]                     0.0370
                                 (1.8744)
C(state)[T.MI]                     0.0363
                                 (1.9899)
C(state)[T.MN]                     0.0932
                                 (8.6047)
C(state)[T.MO]                    -0.0056
                                (-12.033)
C(state)[T.MS]                     0.0147
                                 (2.1430)
C(state)[T.MT]                    -0.0183
                                (-9.6530)
C(state)[T.NC]                    -0.0672
                                (-1.8041)
C(state)[T.ND]                     0.0130
                                 (1.8765)
C(state)[T.NE]                     0.0105
                                 (2.4846)
C(state)[T.NH]                    -0.0175
                                (-0.6334)
C(state)[T.NJ]                     0.0694
                                 (5.2527)
C(state)[T.NM]                     0.0301
                                 (2.6464)
C(state)[T.NV]                     0.1075
                                 (16.434)
C(state)[T.NY]                     0.0847
                                 (5.1334)
C(state)[T.OH]                    -0.0197
                                (-22.592)
C(state)[T.OK]                    -0.0035
                                (-0.7109)
C(state)[T.OR]                     0.0146
                                 (0.2944)
C(state)[T.PA]                     0.0152
                                 (0.9986)
C(state)[T.RI]                     0.0249
                                 (0.5964)
C(state)[T.SC]                    -0.0530
                                (-2.1043)
C(state)[T.SD]                    -0.0190
                                (-1.4001)
C(state)[T.TN]                     0.0051
                                 (0.5517)
C(state)[T.TX]                     0.0378
                                 (4.0760)
C(state)[T.UT]                     0.0577
                                 (5.8788)
C(state)[T.VA]                     0.0265
                                 (0.5400)
C(state)[T.VT]                     0.0228
                                 (1.0969)
C(state)[T.WA]                     0.1554
                                 (13.780)
C(state)[T.WI]                     0.0723
                                 (5.1954)
C(state)[T.WV]                     0.0205
                                 (1.7212)
C(state)[T.WY]                    -0.0005
                                (-0.0220)
C(year)[T.1995]                    0.0822
                               (        )
np.log(rincome)                   -0.0296
                             (-8.462e+06)
taxs                               0.0051
                              (2.521e+08)
-----------------------------------------

T-stats reported in parentheses
T-stats use same covariance type as original model
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/envs/codeforecon/lib/python3.8/site-packages/linearmodels/iv/results.py:180: RuntimeWarning: invalid value encountered in sqrt
  std_errors = sqrt(diag(self.cov))
</pre></div>
</div>
</div>
</div>
<p>There are more tests and checks available. For example, Wooldridge’s regression test of exogeneity uses regression residuals from the endogenous variables regressed on the exogenous variables and the instrument to test for endogenity and is available to run on fitted model results. Let’s check that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_iv2sls</span><span class="o">.</span><span class="n">wooldridge_regression</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wooldridge&#39;s regression test of exogeneity
H0: Endogenous variables are exogenous
Statistic: 3332097971792274.0000
P-value: 0.0000
Distributed: chi2(1)
WaldTestStatistic, id: 0x7f9ffd62ae20
</pre></div>
</div>
</div>
</div>
<p>We can compare the IV results against (naive) OLS. First, run the OLS equivalent:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_cig_ols</span> <span class="o">=</span> <span class="n">IV2SLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
    <span class="s2">&quot;np.log(packs) ~ 1 + np.log(rincome) + C(year) + C(state) + np.log(rprice)&quot;</span><span class="p">,</span> <span class="n">df</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;clustered&quot;</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now select these two models to compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">linearmodels.iv.results</span> <span class="kn">import</span> <span class="n">compare</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="s2">&quot;OLS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_cig_ols</span>
<span class="n">res</span><span class="p">[</span><span class="s2">&quot;2SLS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_iv2sls</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                    Model Comparison                    
========================================================
                                   OLS              2SLS
--------------------------------------------------------
Dep. Variable            np.log(packs)     np.log(packs)
Estimator                          OLS           IV-2SLS
No. Observations                    96                96
Cov. Est.                    clustered         clustered
R-squared                       0.9675            0.9659
Adj. R-squared                  0.9313            0.9279
F-statistic                 -1.209e+17        -1.349e+16
P-value (F-stat)                1.0000            1.0000
==================     ===============   ===============
Intercept                       8.3597            9.4924
                              (484.80)          (360.24)
C(state)[T.AR]                  0.1686            0.1770
                              (3.7460)          (3.3338)
C(state)[T.AZ]                 -0.1280           -0.0899
                             (-49.908)         (-6.8132)
C(state)[T.CA]                 -0.3320           -0.2781
                             (-9.0787)         (-12.996)
C(state)[T.CO]                 -0.2591           -0.2479
                             (-345.21)         (-27.625)
C(state)[T.CT]                 -0.1042           -0.0171
                             (-3.8346)         (-0.8720)
C(state)[T.DE]                  0.0900            0.1110
                              (3.3042)          (3.8105)
C(state)[T.FL]                  0.0325            0.0762
                              (1.9171)          (5.3596)
C(state)[T.GA]                 -0.0691           -0.0695
                             (-2.4532)         (-2.7706)
C(state)[T.IA]                 -0.0143            0.0120
                             (-0.2380)          (0.1629)
C(state)[T.ID]                 -0.1422           -0.1272
                             (-8.4099)         (-16.597)
C(state)[T.IL]                 -0.0766           -0.0339
                             (-10.214)         (-4.1912)
C(state)[T.IN]                  0.1231            0.1198
                              (2.0976)          (1.9609)
C(state)[T.KS]                 -0.1073           -0.0910
                             (-4.8883)         (-2.9884)
C(state)[T.KY]                  0.3803            0.3525
                              (6.6476)          (5.5906)
C(state)[T.LA]                  0.1174            0.1315
                              (12.648)          (12.664)
C(state)[T.MA]                 -0.1055           -0.0403
                             (-10.125)         (-5.8826)
C(state)[T.MD]                 -0.2572           -0.2322
                             (-62.161)         (-9.7376)
C(state)[T.ME]                  0.1682            0.2008
                              (3.7655)          (3.5011)
C(state)[T.MI]                  0.0652            0.1268
                              (1.4699)          (1.7009)
C(state)[T.MN]                 -0.0051            0.0568
                             (-0.1580)          (1.1595)
C(state)[T.MO]                  0.0600            0.0640
                              (1.2722)          (1.3454)
C(state)[T.MS]                  0.1472            0.1501
                              (6.1510)          (5.5267)
C(state)[T.MT]                 -0.1469           -0.1522
                             (-26.043)         (-28.250)
C(state)[T.NC]                  0.0609            0.0396
                              (7.1838)          (2.0655)
C(state)[T.ND]                 -0.0595           -0.0311
                             (-1.9467)         (-0.7787)
C(state)[T.NE]                 -0.1002           -0.0741
                             (-3.4255)         (-1.9765)
C(state)[T.NH]                  0.3374            0.3504
                              (14.331)          (11.114)
C(state)[T.NJ]                 -0.1458           -0.0873
                             (-11.223)         (-1429.3)
C(state)[T.NM]                 -0.2981           -0.2858
                             (-28.465)         (-71.049)
C(state)[T.NV]                  0.1219            0.1789
                              (3.2128)          (6.9075)
C(state)[T.NY]                 -0.1369           -0.0719
                             (-5.8164)         (-22.256)
C(state)[T.OH]                  0.0196            0.0325
                              (0.5379)          (0.8088)
C(state)[T.OK]                  0.0841            0.0946
                              (1.6659)          (1.7572)
C(state)[T.OR]                 -0.0380           -0.0153
                             (-0.7768)         (-0.2269)
C(state)[T.PA]                 -0.0333           -0.0031
                             (-16.905)         (-4.8401)
C(state)[T.RI]                  0.0900            0.1394
                              (1.3979)          (1.5136)
C(state)[T.SC]                 -0.0037           -0.0212
                             (-0.1369)         (-0.6345)
C(state)[T.SD]                 -0.0695           -0.0675
                             (-1.1052)         (-0.9488)
C(state)[T.TN]                  0.1373            0.1473
                              (3.2924)          (3.1340)
C(state)[T.TX]                 -0.0964           -0.0579
                             (-3.8212)         (-4.2560)
C(state)[T.UT]                 -0.5127           -0.4899
                             (-16.600)         (-17.776)
C(state)[T.VA]                 -0.0628           -0.0559
                             (-1.7642)         (-1.1875)
C(state)[T.VT]                  0.2053            0.2209
                              (5.3662)          (4.7267)
C(state)[T.WA]                 -0.0777            0.0064
                             (-6.5481)          (6.0151)
C(state)[T.WI]                  0.0260            0.0741
                              (0.5209)          (1.2569)
C(state)[T.WV]                  0.1490            0.1576
                              (2.4854)          (2.7097)
C(state)[T.WY]                 -0.0150           -0.0169
                             (-0.2771)         (-0.2858)
C(year)[T.1995]                -0.0885           -0.0328
                                             (-3.33e+06)
np.log(rincome)                 0.4974            0.4434
                           (1.115e+07)                  
np.log(rprice)                 -1.0560           -1.2793
                                            (-7.397e+08)
==================== ================= =================
Instruments                                         taxs
--------------------------------------------------------

T-stats reported in parentheses
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/envs/codeforecon/lib/python3.8/site-packages/linearmodels/iv/results.py:180: RuntimeWarning: invalid value encountered in sqrt
  std_errors = sqrt(diag(self.cov))
</pre></div>
</div>
</div>
</div>
<p>Once we take into account the fact that the real price is endogeneous to (realised) demand, we find that its coefficient is more negative; i.e. an increase in the real price of cigarettes creates a bigger fall in number of packs bought.</p>
</section>
<section id="logit-probit-and-generalised-linear-models">
<h2>Logit, probit, and generalised linear models<a class="headerlink" href="#logit-probit-and-generalised-linear-models" title="Permalink to this headline">#</a></h2>
<section id="logit">
<h3>Logit<a class="headerlink" href="#logit" title="Permalink to this headline">#</a></h3>
<p>A logistical regression, aka a logit, is a statistical method for a best-fit line between a regressors <span class="math notranslate nohighlight">\(X\)</span> and an outcome varibale <span class="math notranslate nohighlight">\(y\)</span> that takes on values in <span class="math notranslate nohighlight">\((0, 1)\)</span>.</p>
<p>The function that we’re assuming links the regressors and the outcome has a few different names but the most common is the sigmoid function or the logistic function. The data generating process is assumed to be</p>
<div class="math notranslate nohighlight">
\[
{\displaystyle \mathbb{P}(Y=1\mid X) = \frac{1}{1 + e^{-X'\beta}}}
\]</div>
<p>we can also write this as <span class="math notranslate nohighlight">\(\ln\left(\frac{p}{p-1}\right) = \beta_0 + \sum_i \beta_i x_i\)</span> to get a ‘log-odds’ relationship. The coefficients from a logit model do not have the same interpration as in an OLS estimation, and you can see this from the fact that <span class="math notranslate nohighlight">\(\partial y/\partial x_i \neq \beta_i\)</span> for logit. Of course, you can work out what the partial derivative is for yourself but most packages offer a convenient way to quickly recover the marginal effects.</p>
<p>Logit models are available in <strong>scikit-learn</strong> and <strong>statsmodels</strong> but bear in mind that the <strong>scikit-learn</strong> logit model is, ermm, extremely courageous in that regularisation is applied by default. If you don’t know what that means, don’t worry, but it’s probably best to stick with <strong>statsmodels</strong> as we will do in this example.</p>
<p>We will predict a target <code class="docutils literal notranslate"><span class="pre">GRADE</span></code>, representing whether a grade improved or not, based on some regressors including participation in a programme.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the data from Spector and Mazzeo (1980)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">spector</span><span class="o">.</span><span class="n">load_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="c1"># Look at info on data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">spector</span><span class="o">.</span><span class="n">NOTE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>::

    Number of Observations - 32

    Number of Variables - 4

    Variable name definitions::

        Grade - binary variable indicating whether or not a student&#39;s grade
                improved.  1 indicates an improvement.
        TUCE  - Test score on economics test
        PSI   - participation in program
        GPA   - Student&#39;s grade point average
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_logit</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="s2">&quot;GRADE ~ GPA + TUCE + PSI&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_logit</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.402801
         Iterations 7
                           Logit Regression Results                           
==============================================================================
Dep. Variable:                  GRADE   No. Observations:                   32
Model:                          Logit   Df Residuals:                       28
Method:                           MLE   Df Model:                            3
Date:                Wed, 01 Feb 2023   Pseudo R-squ.:                  0.3740
Time:                        00:42:51   Log-Likelihood:                -12.890
converged:                       True   LL-Null:                       -20.592
Covariance Type:            nonrobust   LLR p-value:                  0.001502
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -13.0213      4.931     -2.641      0.008     -22.687      -3.356
GPA            2.8261      1.263      2.238      0.025       0.351       5.301
TUCE           0.0952      0.142      0.672      0.501      -0.182       0.373
PSI            2.3787      1.065      2.234      0.025       0.292       4.465
==============================================================================
</pre></div>
</div>
</div>
</div>
<p>So, did participation (<code class="docutils literal notranslate"><span class="pre">PSI</span></code>) help increase a grade? Yes. But we need to check the marginal effect to say exactly how much. We’ll use <code class="docutils literal notranslate"><span class="pre">get_margeff</span></code> to do this, we’d like the <span class="math notranslate nohighlight">\(dy/dx\)</span> effect, and we’ll take it at the mean of each regressor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marg_effect</span> <span class="o">=</span> <span class="n">res_logit</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dydx&quot;</span><span class="p">)</span>
<span class="n">marg_effect</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Logit Marginal Effects</caption>
<tr>
  <th>Dep. Variable:</th> <td>GRADE</td>
</tr>
<tr>
  <th>Method:</th>        <td>dydx</td> 
</tr>
<tr>
  <th>At:</th>            <td>mean</td> 
</tr>
</table>
<table class="simpletable">
<tr>
    <th></th>      <th>dy/dx</th>    <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>GPA</th>  <td>    0.5339</td> <td>    0.237</td> <td>    2.252</td> <td> 0.024</td> <td>    0.069</td> <td>    0.998</td>
</tr>
<tr>
  <th>TUCE</th> <td>    0.0180</td> <td>    0.026</td> <td>    0.685</td> <td> 0.493</td> <td>   -0.033</td> <td>    0.069</td>
</tr>
<tr>
  <th>PSI</th>  <td>    0.4493</td> <td>    0.197</td> <td>    2.284</td> <td> 0.022</td> <td>    0.064</td> <td>    0.835</td>
</tr>
</table></div></div>
</div>
<p>So participation gives almost half a grade increase.</p>
</section>
<section id="probit">
<h3>Probit<a class="headerlink" href="#probit" title="Permalink to this headline">#</a></h3>
<p>Probit is very similar to logit: it’s a statistical method for a best-fit line between regressors <span class="math notranslate nohighlight">\(X\)</span> and an outcome varibale <span class="math notranslate nohighlight">\(y\)</span> that takes on values in <span class="math notranslate nohighlight">\((0, 1)\)</span>. And, just like with logit, the function that we’re assuming links the regressors and the outcome has a few different names!</p>
<p>The data generating process is assumed to be</p>
<div class="math notranslate nohighlight">
\[
{\displaystyle \mathbb{P}(Y=1\mid X)=\Phi (X^{T}\beta )}
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
{\displaystyle \Phi (x)={\frac {1}{\sqrt {2\pi }}}\int _{-\infty }^{x}e^{-{\frac {y^{2}}{2}}}dy.}
\]</div>
<p>is the cumulative standard normal (aka Gaussian) distribution. The coefficients from a probit model do not have the same interpration as in an OLS estimation, and you can see this from the fact that <span class="math notranslate nohighlight">\(\partial y/\partial x_i \neq \beta_i\)</span> for probit. And, just as with logit, although you can derive the marginal effects, most packages offer a convenient way to quickly recover them.</p>
<p>We can re-use our previous example of predicting a target <code class="docutils literal notranslate"><span class="pre">GRADE</span></code>, representing whether a grade improved or not, based on some regressors including participation (PSI) in a programme.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_probit</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">probit</span><span class="p">(</span><span class="s2">&quot;GRADE ~ GPA + TUCE + PSI&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_probit</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.400588
         Iterations 6
                          Probit Regression Results                           
==============================================================================
Dep. Variable:                  GRADE   No. Observations:                   32
Model:                         Probit   Df Residuals:                       28
Method:                           MLE   Df Model:                            3
Date:                Wed, 01 Feb 2023   Pseudo R-squ.:                  0.3775
Time:                        00:42:51   Log-Likelihood:                -12.819
converged:                       True   LL-Null:                       -20.592
Covariance Type:            nonrobust   LLR p-value:                  0.001405
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -7.4523      2.542     -2.931      0.003     -12.435      -2.469
GPA            1.6258      0.694      2.343      0.019       0.266       2.986
TUCE           0.0517      0.084      0.617      0.537      -0.113       0.216
PSI            1.4263      0.595      2.397      0.017       0.260       2.593
==============================================================================
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_marg_effect</span> <span class="o">=</span> <span class="n">res_probit</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dydx&quot;</span><span class="p">)</span>
<span class="n">p_marg_effect</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Probit Marginal Effects</caption>
<tr>
  <th>Dep. Variable:</th> <td>GRADE</td>
</tr>
<tr>
  <th>Method:</th>        <td>dydx</td> 
</tr>
<tr>
  <th>At:</th>            <td>mean</td> 
</tr>
</table>
<table class="simpletable">
<tr>
    <th></th>      <th>dy/dx</th>    <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>GPA</th>  <td>    0.5333</td> <td>    0.232</td> <td>    2.294</td> <td> 0.022</td> <td>    0.078</td> <td>    0.989</td>
</tr>
<tr>
  <th>TUCE</th> <td>    0.0170</td> <td>    0.027</td> <td>    0.626</td> <td> 0.531</td> <td>   -0.036</td> <td>    0.070</td>
</tr>
<tr>
  <th>PSI</th>  <td>    0.4679</td> <td>    0.188</td> <td>    2.494</td> <td> 0.013</td> <td>    0.100</td> <td>    0.836</td>
</tr>
</table></div></div>
</div>
<p>It’s no coincidence that we find very similar results here because the two functions we’re using don’t actually look all that different:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">support</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">logistic</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">support</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Logistic&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">support</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Probit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_101_0.svg" src="_images/econmt-regression_101_0.svg" /></div>
</div>
<p>What difference there is, is that logistic regression puts more weight into the tails of the distribution. Arguably, logit is easier to interpret too. With logistic regression, a one unit change in <span class="math notranslate nohighlight">\(x_i\)</span> is associated with a <span class="math notranslate nohighlight">\(\beta_i\)</span> change in the log odds of a 1 outcome or, alternatively, an <span class="math notranslate nohighlight">\(e^{\beta_i}\)</span>-fold change in the odds, all else being equal. With a probit, this is a change of <span class="math notranslate nohighlight">\(\beta_i z\)</span> for <span class="math notranslate nohighlight">\(z\)</span> a normalised variable that you’d have to convert into a predicted probability using the normal CDF.</p>
</section>
<section id="generalised-linear-models">
<h3>Generalised linear models<a class="headerlink" href="#generalised-linear-models" title="Permalink to this headline">#</a></h3>
<p>Logit and probit (and OLS for that matter) as special cases of a class of models such that <span class="math notranslate nohighlight">\(g\)</span> is a ‘link’ function connects a function of regressors to the output, and <span class="math notranslate nohighlight">\(\mu\)</span> is the mean of a conditional response distribution at a given point in the space of regressors. When <span class="math notranslate nohighlight">\(g(\mu) = X'\beta\)</span>, we just get regular OLS. When it’s logit, we have</p>
<div class="math notranslate nohighlight">
\[
{\displaystyle \mu= \mathbb{E}(Y\mid X=x) =g^{-1}(X'\beta)= \frac{1}{1 + e^{-X'\beta}}.}
\]</div>
<p>But as well as the ones we’ve seen, there are many possible link functions one can use via the catch-all <code class="docutils literal notranslate"><span class="pre">glm</span></code> function. These come in different ‘families’ of distributions, with the default for the binomial family being logit. So, running <code class="docutils literal notranslate"><span class="pre">smf.glm('GRADE</span> <span class="pre">~</span> <span class="pre">GPA</span> <span class="pre">+</span> <span class="pre">TUCE</span> <span class="pre">+</span> <span class="pre">PSI',</span> <span class="pre">data=df,</span> <span class="pre">family=sm.families.Binomial()).fit()</span></code> will produce exactly the same as we got both using the <code class="docutils literal notranslate"><span class="pre">logit</span></code> function. For more on the families of distributions and possible link functions, see the <a class="reference external" href="https://www.statsmodels.org/stable/glm.html">relevant part</a> of the <strong>statsmodels</strong> documentation.</p>
<p>If you need a library dedicated to GLMs that has all the bells and whistles you can dream of, you might want to check out <a class="reference external" href="https://glum.readthedocs.io/en/latest/">glum</a>. At the time of writing, it is <a class="reference external" href="https://glum.readthedocs.io/en/latest/benchmarks.html">faster</a> than either GLMnet or H2O (two other popular GLM libraries).</p>
</section>
</section>
<section id="linear-mixed-effects-regressions-lmer">
<h2>Linear Mixed Effects Regressions (LMER)<a class="headerlink" href="#linear-mixed-effects-regressions-lmer" title="Permalink to this headline">#</a></h2>
<p>Linear mixed models are an extension of simple linear models to allow both fixed and random effects.</p>
<p>We’ll be using the <strong>statsmodels</strong> package to demonstrate this, along with the dietox dataset, which has data on the growth curves of pigs. The data are taken from a study of the “Influence of Dietary Rapeseed Oli, Vitamin E, and Copper on Performance and Antioxidant and Oxidative Status of Pigs” <span id="id4">Lauridsen <em>et al.</em> [<a class="reference internal" href="zreferences.html#id41" title="Charlotte Lauridsen, Søren Højsgaard, and Martin Tang Sørensen. Influence of dietary rapeseed oil, vitamin e, and copper on the performance and the antioxidative and oxidative status of pigs. Journal of animal science, 77(4):906–916, 1999.">1999</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_rdataset</span><span class="p">(</span><span class="s1">&#39;dietox&#39;</span><span class="p">,</span> <span class="s1">&#39;geepack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Pig</th>
      <th>Evit</th>
      <th>Cu</th>
      <th>Litter</th>
      <th>Start</th>
      <th>Weight</th>
      <th>Feed</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4601</td>
      <td>Evit000</td>
      <td>Cu000</td>
      <td>1</td>
      <td>26.5</td>
      <td>26.50000</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4601</td>
      <td>Evit000</td>
      <td>Cu000</td>
      <td>1</td>
      <td>26.5</td>
      <td>27.59999</td>
      <td>5.200005</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4601</td>
      <td>Evit000</td>
      <td>Cu000</td>
      <td>1</td>
      <td>26.5</td>
      <td>36.50000</td>
      <td>17.600000</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4601</td>
      <td>Evit000</td>
      <td>Cu000</td>
      <td>1</td>
      <td>26.5</td>
      <td>40.29999</td>
      <td>28.500000</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4601</td>
      <td>Evit000</td>
      <td>Cu000</td>
      <td>1</td>
      <td>26.5</td>
      <td>49.09998</td>
      <td>45.200001</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we’re going to regress the weight of the pigs on the time and a couple of random effects.</p>
<p>We fit two random effects for each pig: a random intercept, and a random slope (with respect to time). This means that each pig may have a different baseline weight, as well as grow at a different rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="s2">&quot;Weight ~ Time&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Pig&quot;</span><span class="p">],</span> <span class="n">re_formula</span><span class="o">=</span><span class="s2">&quot;~Time&quot;</span><span class="p">)</span>
<span class="n">mdf</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">])</span>
<span class="n">mdf</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
       <td>Model:</td>       <td>MixedLM</td> <td>Dependent Variable:</td>   <td>Weight</td>  
</tr>
<tr>
  <td>No. Observations:</td>   <td>861</td>         <td>Method:</td>          <td>REML</td>   
</tr>
<tr>
     <td>No. Groups:</td>      <td>72</td>          <td>Scale:</td>          <td>6.0372</td>  
</tr>
<tr>
  <td>Min. group size:</td>    <td>11</td>      <td>Log-Likelihood:</td>   <td>-2217.0475</td>
</tr>
<tr>
  <td>Max. group size:</td>    <td>12</td>        <td>Converged:</td>          <td>Yes</td>   
</tr>
<tr>
  <td>Mean group size:</td>   <td>12.0</td>            <td></td>                <td></td>     
</tr>
</table>
<table class="simpletable">
<tr>
          <td></td>          <th>Coef.</th> <th>Std.Err.</th>    <th>z</th>   <th>P>|z|</th> <th>[0.025</th> <th>0.975]</th>
</tr>
<tr>
  <th>Intercept</th>        <td>15.739</td>   <td>0.550</td>  <td>28.603</td> <td>0.000</td> <td>14.660</td> <td>16.817</td>
</tr>
<tr>
  <th>Time</th>              <td>6.939</td>   <td>0.080</td>  <td>86.925</td> <td>0.000</td>  <td>6.783</td>  <td>7.095</td>
</tr>
<tr>
  <th>Group Var</th>        <td>19.503</td>   <td>1.561</td>     <td></td>      <td></td>       <td></td>       <td></td>   
</tr>
<tr>
  <th>Group x Time Cov</th>  <td>0.294</td>   <td>0.153</td>     <td></td>      <td></td>       <td></td>       <td></td>   
</tr>
<tr>
  <th>Time Var</th>          <td>0.416</td>   <td>0.033</td>     <td></td>      <td></td>       <td></td>       <td></td>   
</tr>
</table></div></div>
</div>
<p>This is saying that we have 72 pigs with 861 observations between them. The “Group Var” here is the random effect intercept for pigs, and it has a variance of 19.5. Meanwhile the slope random effect has a variance of 0.416. In addition to these, there are the two fixed effects. It’s easier to see where all of these estimates come out by plotting them. We’ll be honest, plotting the estimates hasn’t been made easy—so getting the data out and configuring it isn’t as easy as it could be.</p>
<p>First we pop the random effects results into a dataframe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">group_time_ests</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">random_effects</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;position_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Group&quot;</span>
<span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;position_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time&quot;</span>
<span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
<span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_time_ests</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span>
<span class="n">group_time_ests</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Group</th>
      <th>Time</th>
      <th>position_group</th>
      <th>position_time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4601</th>
      <td>15.109694</td>
      <td>6.848209</td>
      <td>Group</td>
      <td>Time</td>
    </tr>
    <tr>
      <th>4602</th>
      <td>16.133875</td>
      <td>7.364919</td>
      <td>Group</td>
      <td>Time</td>
    </tr>
    <tr>
      <th>4603</th>
      <td>17.846672</td>
      <td>7.235199</td>
      <td>Group</td>
      <td>Time</td>
    </tr>
    <tr>
      <th>4605</th>
      <td>19.771567</td>
      <td>7.374041</td>
      <td>Group</td>
      <td>Time</td>
    </tr>
    <tr>
      <th>4641</th>
      <td>17.265125</td>
      <td>8.143678</td>
      <td>Group</td>
      <td>Time</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now let’s plot the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn.objects</span> <span class="k">as</span> <span class="nn">so</span>

<span class="n">details_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Intercept&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Random effects: Pig model&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">details_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">mdf</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">sns_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">so</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">group_time_ests</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;position_group&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dots</span><span class="p">(),</span> <span class="n">so</span><span class="o">.</span><span class="n">Jitter</span><span class="p">())</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dots</span><span class="p">(),</span> <span class="n">so</span><span class="o">.</span><span class="n">Jitter</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;position_time&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_111_0.svg" src="_images/econmt-regression_111_0.svg" /></div>
</div>
</section>
<section id="linear-probability-model">
<h2>Linear probability model<a class="headerlink" href="#linear-probability-model" title="Permalink to this headline">#</a></h2>
<p>When <span class="math notranslate nohighlight">\(y\)</span> takes values in <span class="math notranslate nohighlight">\(\{0, 1\}\)</span> but the model looks like</p>
<div class="math notranslate nohighlight">
\[
y = x' \cdot \beta
\]</div>
<p>and is estimated by OLS then you have a linear probability model. In this case, the interpretion of a unit change in <span class="math notranslate nohighlight">\(x_i\)</span> is that it induces a <span class="math notranslate nohighlight">\(\beta_i\)</span> <em>change in probability</em> of <span class="math notranslate nohighlight">\(y\)</span>. Note that homoskedasticity does not hold for the linear probability model.</p>
</section>
<section id="violations-of-the-classical-linear-model-clm">
<h2>Violations of the classical linear model (CLM)<a class="headerlink" href="#violations-of-the-classical-linear-model-clm" title="Permalink to this headline">#</a></h2>
<section id="heteroskedasticity">
<h3>Heteroskedasticity<a class="headerlink" href="#heteroskedasticity" title="Permalink to this headline">#</a></h3>
<p>If an estimated model is homoskedastic then its random variables have equal (finite) variance. This is also known as homogeneity of variance. Another way of putting it is that, for all <em>observations</em> <span class="math notranslate nohighlight">\(i\)</span> in an estimated model <span class="math notranslate nohighlight">\(y_i = X_i\hat{\beta} + \epsilon_i\)</span> then</p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}(\epsilon_i \epsilon_i) = \sigma^2
\]</div>
<p>When this relationship does not hold, an estimated model is said to be heteroskedastic.</p>
<p>To test for heteroskedasticity, you can use <strong>statsmodels</strong>’ versions of the <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.stats.diagnostic.het_breuschpagan.html#statsmodels.stats.diagnostic.het_breuschpagan">Breusch-Pagan</a> or <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.stats.diagnostic.het_white.html#statsmodels.stats.diagnostic.het_white">White</a> tests with the null hypothesis that the estimated model is homoskedastic. If the null hypothesis is rejected, then standard errors, t-statistics, and F-statistics are invalidated. In this case, you will need HAC (heteroskedasticity and auto-correlation consistent) standard errors, t- and F-statistics.</p>
<p>To obtain HAC standard errors from existing regression results in a variable <code class="docutils literal notranslate"><span class="pre">results</span></code>, you can use (for 1 lag):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">get_robustcov_results</span><span class="p">(</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">maxlags</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="quantile-regression">
<h2>Quantile regression<a class="headerlink" href="#quantile-regression" title="Permalink to this headline">#</a></h2>
<p>Quantile regression estimates the conditional quantiles of a response variable. In some cases, it can be more robust to outliers and, in the case of the <span class="math notranslate nohighlight">\(q=0.5\)</span> quantile it is equivalent LAD (Least Absolute Deviation) regression. Let’s look at an example of quantile regression in action, lifted direct from the <strong>statsmodels</strong> <a class="reference external" href="https://www.statsmodels.org/dev/examples/notebooks/generated/quantile_regression.html">documentation</a> and based on a Journal of Economic Perspectives paper by Koenker and Hallock.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">engel</span><span class="o">.</span><span class="n">load_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>income</th>
      <th>foodexp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>420.157651</td>
      <td>255.839425</td>
    </tr>
    <tr>
      <th>1</th>
      <td>541.411707</td>
      <td>310.958667</td>
    </tr>
    <tr>
      <th>2</th>
      <td>901.157457</td>
      <td>485.680014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>639.080229</td>
      <td>402.997356</td>
    </tr>
    <tr>
      <th>4</th>
      <td>750.875606</td>
      <td>495.560775</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What we have here are two sets of related data. Let’s perform several quantile regressions from 0.1 to 0.9 in steps of 0.1</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">quantreg</span><span class="p">(</span><span class="s2">&quot;foodexp ~ income&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="n">quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">q_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The <span class="math notranslate nohighlight">\(q=0.5\)</span> entry will be at the <code class="docutils literal notranslate"><span class="pre">4</span></code> index; let’s take a look at it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">q_results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                         QuantReg Regression Results                          
==============================================================================
Dep. Variable:                foodexp   Pseudo R-squared:               0.6206
Model:                       QuantReg   Bandwidth:                       64.51
Method:                 Least Squares   Sparsity:                        209.3
Date:                Wed, 01 Feb 2023   No. Observations:                  235
Time:                        00:42:53   Df Residuals:                      233
                                        Df Model:                            1
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     81.4823     14.634      5.568      0.000      52.649     110.315
income         0.5602      0.013     42.516      0.000       0.534       0.586
==============================================================================

The condition number is large, 2.38e+03. This might indicate that there are
strong multicollinearity or other numerical problems.
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the results for all of the regressions <em>and</em> let’s add in OLS for comparison:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ols_res</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;foodexp ~ income&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">get_y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">income</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">income</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">50</span><span class="p">)</span>
<span class="c1"># Just to make the plot clearer</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_max</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;foodexp&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q_results</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">get_y</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$q=</span><span class="si">{</span><span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">get_y</span><span class="p">(</span><span class="n">ols_res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">],</span> <span class="n">ols_res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;OLS&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_121_0.svg" src="_images/econmt-regression_121_0.svg" /></div>
</div>
<p>This chart shows very clearly how quantile regression differs from OLS. The line fitted by OLS is trying to be all things to all points whereas the line fitted by quantile regression is focused only on its quantile. You can also see how points far from the median (not all shown) may be having a large influence on the OLS line.</p>
</section>
<section id="rolling-and-recursive-regressions">
<h2>Rolling and recursive regressions<a class="headerlink" href="#rolling-and-recursive-regressions" title="Permalink to this headline">#</a></h2>
<p>Rolling ordinary least squares applies OLS (ordinary least squares) across a fixed window of observations and then rolls (moves or slides) that window across the data set. They key parameter is <code class="docutils literal notranslate"><span class="pre">window</span></code>, which determines the number of observations used in each OLS regression. Recursive regression is equivalent to rolling regression but with a window that expands over time.</p>
<p>Let’s first create some synthetic data to perform estimation on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.regression.rolling</span> <span class="kn">import</span> <span class="n">RollingOLS</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;feature0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;feature1&quot;</span><span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature0</th>
      <th>feature1</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.955945</td>
      <td>-0.345982</td>
      <td>-36.740556</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.225436</td>
      <td>0.844363</td>
      <td>7.190031</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.692050</td>
      <td>1.536377</td>
      <td>44.389018</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.010500</td>
      <td>1.785870</td>
      <td>57.019515</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.895467</td>
      <td>0.386902</td>
      <td>-16.088554</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now let’s fit the model using a formula and a <code class="docutils literal notranslate"><span class="pre">window</span></code> of 25 steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">roll_reg</span> <span class="o">=</span> <span class="n">RollingOLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
    <span class="s2">&quot;target ~ feature0 + feature1 -1&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">roll_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note that -1 in the formala suppresses the intercept. We can see the parameters using <code class="docutils literal notranslate"><span class="pre">model.params</span></code>. Here are the params for time steps between 20 and 30:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature0</th>
      <th>feature1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>20</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>21</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>22</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>27</th>
      <td>20.532655</td>
      <td>34.919468</td>
    </tr>
    <tr>
      <th>28</th>
      <td>20.470171</td>
      <td>35.365235</td>
    </tr>
    <tr>
      <th>29</th>
      <td>20.002261</td>
      <td>35.666997</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 2 columns</p>
</div></div></div>
</div>
<p>Note that there aren’t parameters for entries between 0 and 23 because our window is 25 steps wide. We can easily look at how any of the coefficients are changing over time. Here’s an example for ‘feature0’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">plot_recursive_coefficient</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;feature0&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Coefficient value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_130_0.svg" src="_images/econmt-regression_130_0.svg" /></div>
</div>
<p>A rolling regression with an <em>expanding</em> rather than <em>moving</em> window is effectively a recursive least squares model. We can do this instead using the <code class="docutils literal notranslate"><span class="pre">RecursiveLS</span></code> function from <strong>statsmodels</strong>. Let’s fit this to the whole dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_rls</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">RecursiveLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="s2">&quot;target ~ feature0 + feature1 -1&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="n">model_rls</span> <span class="o">=</span> <span class="n">reg_rls</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_rls</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                           Statespace Model Results                           
==============================================================================
Dep. Variable:                 target   No. Observations:                  200
Model:                    RecursiveLS   Log Likelihood                -570.923
Date:                Wed, 01 Feb 2023   R-squared:                       0.988
Time:                        00:42:54   AIC                           1145.847
Sample:                             0   BIC                           1152.444
                                - 200   HQIC                          1148.516
Covariance Type:            nonrobust   Scale                           17.413
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
feature0      20.6872      0.296     69.927      0.000      20.107      21.267
feature1      34.0655      0.302    112.870      0.000      33.474      34.657
===================================================================================
Ljung-Box (L1) (Q):                   2.02   Jarque-Bera (JB):                 3.93
Prob(Q):                              0.16   Prob(JB):                         0.14
Heteroskedasticity (H):               1.17   Skew:                            -0.31
Prob(H) (two-sided):                  0.51   Kurtosis:                         3.31
===================================================================================

Warnings:
[1] Parameters and covariance matrix estimates are RLS estimates conditional on the entire sample.
</pre></div>
</div>
</div>
</div>
<p>But now we can look back at how the values of the coefficients changed over time too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">model_rls</span><span class="o">.</span><span class="n">plot_recursive_coefficient</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">reg_rls</span><span class="o">.</span><span class="n">k_exog</span><span class="p">),</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span>
<span class="p">)</span>
<span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time step&quot;</span><span class="p">)</span>
<span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Coefficient value&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_134_0.svg" src="_images/econmt-regression_134_0.svg" /></div>
</div>
</section>
<section id="regression-plots">
<h2>Regression plots<a class="headerlink" href="#regression-plots" title="Permalink to this headline">#</a></h2>
<p><strong>statsmodels</strong> has a number of built-in plotting methods to help you understand how well your regression is capturing the relationships you’re looking for. Let’s see a few examples of these using <strong>statsmodels</strong> built-in Statewide Crime data set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crime_data</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">statecrime</span><span class="o">.</span><span class="n">load_pandas</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">statecrime</span><span class="o">.</span><span class="n">NOTE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>::

    Number of observations: 51
    Number of variables: 8
    Variable name definitions:

    state
        All 50 states plus DC.
    violent
        Rate of violent crimes / 100,000 population. Includes murder, forcible
        rape, robbery, and aggravated assault. Numbers for Illinois and
        Minnesota do not include forcible rapes. Footnote included with the
        American Statistical Abstract table reads:
        &quot;The data collection methodology for the offense of forcible
        rape used by the Illinois and the Minnesota state Uniform Crime
        Reporting (UCR) Programs (with the exception of Rockford, Illinois,
        and Minneapolis and St. Paul, Minnesota) does not comply with
        national UCR guidelines. Consequently, their state figures for
        forcible rape and violent crime (of which forcible rape is a part)
        are not published in this table.&quot;
    murder
        Rate of murders / 100,000 population.
    hs_grad
        Percent of population having graduated from high school or higher.
    poverty
        % of individuals below the poverty line
    white
        Percent of population that is one race - white only. From 2009 American
        Community Survey
    single
        Calculated from 2009 1-year American Community Survey obtained obtained
        from Census. Variable is Male householder, no wife present, family
        household combined with Female householder, no husband present, family
        household, divided by the total number of Family households.
    urban
        % of population in Urbanized Areas as of 2010 Census. Urbanized
        Areas are area of 50,000 or more people.
</pre></div>
</div>
</div>
</div>
<p>First, let’s look at a Q-Q plot to get a sense of how the variables are distributed. This uses <strong>scipy</strong>’s stats module. The default distribution is normal but you can use any that <strong>scipy</strong> supports.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">st</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">crime_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;murder&quot;</span><span class="p">],</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_138_0.svg" src="_images/econmt-regression_138_0.svg" /></div>
</div>
<p>Clearly, this is not quite normal and there are some serious outliers in the tails.</p>
<p>Let’s run take a look at the unconditional relationship we’re interested in: how murder depends on high school graduation. We’ll use <a class="reference external" href="https://plotnine.readthedocs.io/en/stable/index.html"><strong>plotnine</strong></a>’s <code class="docutils literal notranslate"><span class="pre">geom_smooth</span></code> to do this but bear in mind it will only run a linear model of <code class="docutils literal notranslate"><span class="pre">'murder</span> <span class="pre">~</span> <span class="pre">hs_grad'</span></code> and ignore the other covariates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="o">*</span>

<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">crime_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;murder&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;hs_grad&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_140_0.svg" src="_images/econmt-regression_140_0.svg" /><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8770281830876)&gt;
</pre></div>
</div>
</div>
</div>
<p>We can take into account those other factors by using a partial regression plot that asks what does <span class="math notranslate nohighlight">\(\mathbb{E}(y|X)\)</span> look like as a function of <span class="math notranslate nohighlight">\(\mathbb{E}(x_i|X)\)</span>? (Use <code class="docutils literal notranslate"><span class="pre">obs_labels=False</span></code> to remove data point labels.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}):</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_partregress</span><span class="p">(</span>
        <span class="n">endog</span><span class="o">=</span><span class="s2">&quot;murder&quot;</span><span class="p">,</span>
        <span class="n">exog_i</span><span class="o">=</span><span class="s2">&quot;hs_grad&quot;</span><span class="p">,</span>
        <span class="n">exog_others</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">,</span> <span class="s2">&quot;poverty&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="n">crime_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">obs_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>eval_env: 1
</pre></div>
</div>
<img alt="_images/econmt-regression_142_1.svg" src="_images/econmt-regression_142_1.svg" /></div>
</div>
<p>At this point, the results of the regression are useful context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_crime</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span>
    <span class="s2">&quot;murder ~ hs_grad + urban + poverty + single&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">crime_data</span><span class="o">.</span><span class="n">data</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_crime</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                 murder   R-squared:                       0.813
Model:                            OLS   Adj. R-squared:                  0.797
Method:                 Least Squares   F-statistic:                     50.08
Date:                Wed, 01 Feb 2023   Prob (F-statistic):           3.42e-16
Time:                        00:42:56   Log-Likelihood:                -95.050
No. Observations:                  51   AIC:                             200.1
Df Residuals:                      46   BIC:                             209.8
Df Model:                           4                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept    -44.1024     12.086     -3.649      0.001     -68.430     -19.774
hs_grad        0.3059      0.117      2.611      0.012       0.070       0.542
urban          0.0109      0.015      0.707      0.483      -0.020       0.042
poverty        0.4121      0.140      2.939      0.005       0.130       0.694
single         0.6374      0.070      9.065      0.000       0.496       0.779
==============================================================================
Omnibus:                        1.618   Durbin-Watson:                   2.507
Prob(Omnibus):                  0.445   Jarque-Bera (JB):                0.831
Skew:                          -0.220   Prob(JB):                        0.660
Kurtosis:                       3.445   Cond. No.                     5.80e+03
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[2] The condition number is large, 5.8e+03. This might indicate that there are
strong multicollinearity or other numerical problems.
</pre></div>
</div>
</div>
</div>
<p>Putting the multicollinearity problems to one side, we see that the relationship shown in the partial regression plot is also implied by the coefficient on <code class="docutils literal notranslate"><span class="pre">hs_grad</span></code> in the regression table.</p>
<p>We can also look at an in-depth summary of one exogenous regressor and its relationship to the outcome variable. Each of these types of regression diagnostic are available individually, or for all regressors at once, too. The first panel is the chart we did with <strong>plotnine</strong> rendered differently (and, one could argue, more informatively). Most of the plots below are self-explanatory except for the third one,  the CCPR (Component-Component plus Residual) plot. This provides a way to judge the effect of one regressor on the response variable by taking into account the effects of the other independent variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_regress_exog</span><span class="p">(</span><span class="n">results_crime</span><span class="p">,</span> <span class="s2">&quot;hs_grad&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>eval_env: 1
</pre></div>
</div>
<img alt="_images/econmt-regression_147_1.svg" src="_images/econmt-regression_147_1.svg" /></div>
</div>
<p><strong>statsmodels</strong> can also produce influence plots of the ‘externally studentised’ residuals vs. the leverage of each observation as measured by the so-called hat matrix <span class="math notranslate nohighlight">\(X(X^{\;\prime}X)^{-1}X^{\;\prime}\)</span> (because it puts the ‘hat’ on <span class="math notranslate nohighlight">\(y\)</span>). Externally studentised residuals are residuals that are scaled by their standard deviation. High leverage points could exert an undue influence over the regression line, but only if the predicted <span class="math notranslate nohighlight">\(y\)</span> values of a regression that was fit with them excluded was quite different. In the example below, DC is having a big influence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}):</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">influence_plot</span><span class="p">(</span><span class="n">results_crime</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_150_0.svg" src="_images/econmt-regression_150_0.svg" /></div>
</div>
<p>Finally, it’s nice to be able to see plots of our coefficients along with their standard errors. There isn’t a built-in <strong>statsmodels</strong> option for this, but happily it’s easy to extract the results of regressions in a sensible format. Using the <code class="docutils literal notranslate"><span class="pre">results</span></code> object from earlier, and excluding the intercept, we can get the coefficients from <code class="docutils literal notranslate"><span class="pre">results.params[1:]</span></code> and the associated errors from <code class="docutils literal notranslate"><span class="pre">results.bse[1:]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Put the results into a dataframe with Name, Coefficient, Error</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results_crime</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">results_crime</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">})</span>
<span class="p">)</span>
<span class="c1"># Plot the coefficient values and their errors</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">res_df</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Coefficient&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_errorbar</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="s2">&quot;Coefficient-Error&quot;</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="s2">&quot;Coefficient+Error&quot;</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_152_0.svg" src="_images/econmt-regression_152_0.svg" /><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8770281952485)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="binscatter">
<h2>Binscatter<a class="headerlink" href="#binscatter" title="Permalink to this headline">#</a></h2>
<p>We’re going to follow the excellent example in this <a class="reference external" href="https://towardsdatascience.com/goodbye-scatterplot-welcome-binned-scatterplot-a928f67413e4">blog post</a> by <a class="reference external" href="https://www.linkedin.com/in/matteo-courthoud/">Matteo Courthoud</a>.</p>
<p>First we’ll generate some fake data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dgp_marketplace</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10_000</span><span class="p">):</span>
    <span class="c1"># Does the firm sells only online?</span>
    <span class="n">online</span> <span class="o">=</span> <span class="n">prng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="c1"># How many products does the firm have</span>
    <span class="n">products</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">prng</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="c1"># What is the age of the firm</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">prng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">products</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> 
    <span class="c1"># Sales</span>
    <span class="n">sales</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">prng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">products</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">products</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">online</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="n">online</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
    <span class="c1"># Generate the dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="n">sales</span><span class="p">,</span> <span class="s1">&#39;online&#39;</span><span class="p">:</span> <span class="n">online</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">:</span> <span class="n">products</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sales</span> <span class="o">=</span> <span class="n">dgp_marketplace</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10_000</span><span class="p">)</span>
<span class="n">sales</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>sales</th>
      <th>online</th>
      <th>products</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2.507089</td>
      <td>1383.896707</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.074963</td>
      <td>2738.994208</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.259299</td>
      <td>10876.933496</td>
      <td>0</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.626234</td>
      <td>12159.344328</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.026536</td>
      <td>1584.629056</td>
      <td>0</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We have pulled down information on 10,000 firms. For each firm we know:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">age</span></code>: the age of the firm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sales</span></code>: the monthly sales from last month</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">online</span></code>: whether the firm is only active online</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">products</span></code>: the number of products that the firm offers</p></li>
</ul>
<p>Suppose we are interested in understanding the relationship between age and sales. What is the life-cycle of sales?</p>
<p>Let’s start with a simple scatterplot of sales vs age.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn.objects</span> <span class="k">as</span> <span class="nn">so</span>

<span class="p">(</span>
    <span class="n">so</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_157_0.png" src="_images/econmt-regression_157_0.png" />
</div>
</div>
<p>This plot is far too crowded to get a real sense of the relationship here.</p>
<p>A linear regression can help us unpick what the relationship really is</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;np.log(sales) ~ np.log(age)&#39;</span><span class="p">,</span> <span class="n">sales</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
       <td></td>          <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>   <td>    7.3964</td> <td>    0.015</td> <td>  488.757</td> <td> 0.000</td> <td>    7.367</td> <td>    7.426</td>
</tr>
<tr>
  <th>np.log(age)</th> <td>    0.1503</td> <td>    0.010</td> <td>   15.588</td> <td> 0.000</td> <td>    0.131</td> <td>    0.169</td>
</tr>
</table></div></div>
</div>
<p>There is a pretty strong positive relationship here that wasn’t evident in the scatter plot. BUT it’s possible that this relationships depends on whether the firms are online-only or not. We can condition on the other variables and do another regression:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;np.log(sales) ~ np.log(age) + C(online) + products&#39;</span><span class="p">,</span> <span class="n">sales</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
         <td></td>           <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>      <td>    6.5413</td> <td>    0.036</td> <td>  181.200</td> <td> 0.000</td> <td>    6.471</td> <td>    6.612</td>
</tr>
<tr>
  <th>C(online)[T.1]</th> <td>    0.1798</td> <td>    0.026</td> <td>    6.888</td> <td> 0.000</td> <td>    0.129</td> <td>    0.231</td>
</tr>
<tr>
  <th>np.log(age)</th>    <td>    0.0642</td> <td>    0.010</td> <td>    6.456</td> <td> 0.000</td> <td>    0.045</td> <td>    0.084</td>
</tr>
<tr>
  <th>products</th>       <td>    0.3521</td> <td>    0.014</td> <td>   25.191</td> <td> 0.000</td> <td>    0.325</td> <td>    0.379</td>
</tr>
</table></div></div>
</div>
<p>The coefficient now looks very different having conditioned on the other confounders. We can see that sales still increase with age, but we don’t know if this relationship is linear or not. We could add extra terms (like age squared) to explore this.</p>
<p>Or, we could use a <em>binned scatterplot</em> to analyse the relationship non-parametrically. The binned scatterplot divides the conditioning variable, <code class="docutils literal notranslate"><span class="pre">age</span></code> in our example, into equally sized bins or quantiles, and then plots the conditional mean of the dependent variable, <code class="docutils literal notranslate"><span class="pre">sales</span></code> in our example, within each bin.</p>
<p>We’ll be using the <a class="reference external" href="https://nppackages.github.io/binsreg/"><strong>binsreg</strong></a> package for this <span id="id5">Cattaneo <em>et al.</em> [<a class="reference internal" href="zreferences.html#id39" title="Matias D Cattaneo, Richard K Crump, Max H Farrell, and Yingjie Feng. On binscatter. arXiv preprint arXiv:1902.09608, 2019.">2019</a>]</span>.</p>
<p>Binned scatterplots do not just provide conditional means for optimally chosen intervals; they can also provide inference for these means. In particular, they will give confidence intervals around each data point. In the <strong>binsreg</strong> package, the <code class="docutils literal notranslate"><span class="pre">ci</span></code> option adds confidence intervals to the estimation results.</p>
<p>As the <strong>binsreg</strong> package is not written in the most Pythonic way, we’ll adorn it a bit to make it more easily used with dataframes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">binsreg</span>

<span class="k">def</span> <span class="nf">binscatter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Estimate binsreg</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">binsreg</span><span class="o">.</span><span class="n">binsreg</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Retrieve estimates</span>
    <span class="n">df_est</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">dots</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">data_plot</span><span class="p">])</span>
    <span class="n">df_est</span> <span class="o">=</span> <span class="n">df_est</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)})</span>
    <span class="c1"># Add confidence intervals</span>
    <span class="k">if</span> <span class="s2">&quot;ci&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">df_est</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_est</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">ci</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">data_plot</span><span class="p">]))</span>
        <span class="n">df_est</span> <span class="o">=</span> <span class="n">df_est</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="n">df_est</span><span class="p">[</span><span class="s1">&#39;ci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_est</span><span class="p">[</span><span class="s1">&#39;ci_r&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_est</span><span class="p">[</span><span class="s1">&#39;ci_l&#39;</span><span class="p">]</span>
    <span class="c1"># Rename groups</span>
    <span class="k">if</span> <span class="s2">&quot;by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">df_est</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_est</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">df_est</span> <span class="o">=</span> <span class="n">df_est</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">df_est</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate binsreg</span>
<span class="n">br_est</span> <span class="o">=</span> <span class="n">binscatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sales</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">br_est</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>age</th>
      <th>bin</th>
      <th>isknot</th>
      <th>mid</th>
      <th>sales</th>
      <th>ci_l</th>
      <th>ci_r</th>
      <th>ci</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Full Sample</td>
      <td>0.010859</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1464.787623</td>
      <td>1071.515840</td>
      <td>1583.280880</td>
      <td>511.765040</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Full Sample</td>
      <td>0.033589</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1796.147300</td>
      <td>1597.311734</td>
      <td>2008.197828</td>
      <td>410.886094</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Full Sample</td>
      <td>0.059490</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1859.670036</td>
      <td>1671.846295</td>
      <td>2109.052975</td>
      <td>437.206680</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Full Sample</td>
      <td>0.086708</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>1886.426934</td>
      <td>1669.795790</td>
      <td>2095.450639</td>
      <td>425.654848</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Full Sample</td>
      <td>0.114412</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1938.436076</td>
      <td>1709.891878</td>
      <td>2248.915920</td>
      <td>539.024041</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can now plot the results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">sns_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">so</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">br_est</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dots</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">br_est</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binscatter: sales as a function of age&quot;</span><span class="p">)</span>
<span class="n">sns_plot</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_166_0.svg" src="_images/econmt-regression_166_0.svg" /></div>
</div>
<p>We can now see that the relationship is non-linear with a sharp increase in <code class="docutils literal notranslate"><span class="pre">sales</span></code> at the beginning of the lifetime of a firm, followed by a plateau.</p>
<p>As noted, this relationship may be modified by other variables though. So let’s now condition on those.</p>
<p>To condition on <code class="docutils literal notranslate"><span class="pre">products</span></code>, we pass <code class="docutils literal notranslate"><span class="pre">w=[&quot;products&quot;]</span></code> to the <code class="docutils literal notranslate"><span class="pre">binscatter</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate binsreg</span>
<span class="n">br_est</span> <span class="o">=</span> <span class="n">binscatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">sales</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">br_est</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>age</th>
      <th>bin</th>
      <th>isknot</th>
      <th>mid</th>
      <th>sales</th>
      <th>ci_l</th>
      <th>ci_r</th>
      <th>ci</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Full Sample</td>
      <td>0.011594</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1993.431855</td>
      <td>1696.328657</td>
      <td>2194.308173</td>
      <td>497.979516</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Full Sample</td>
      <td>0.036091</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2205.494696</td>
      <td>2020.644696</td>
      <td>2413.209800</td>
      <td>392.565104</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Full Sample</td>
      <td>0.063776</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>2456.340262</td>
      <td>2223.387911</td>
      <td>2629.754210</td>
      <td>406.366299</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Full Sample</td>
      <td>0.093066</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>2346.037534</td>
      <td>2173.715566</td>
      <td>2574.592536</td>
      <td>400.876970</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Full Sample</td>
      <td>0.122806</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>2425.527896</td>
      <td>2160.148380</td>
      <td>2686.659801</td>
      <td>526.511421</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now let’s look at the plot of this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">sns_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">so</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">br_est</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dots</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">br_est</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binscatter: sales as a function of age conditioned on products&quot;</span><span class="p">)</span>
<span class="n">sns_plot</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_170_0.svg" src="_images/econmt-regression_170_0.svg" /></div>
</div>
<p>Conditional on the number of <code class="docutils literal notranslate"><span class="pre">products</span></code>, the shape of the <code class="docutils literal notranslate"><span class="pre">sales</span></code> life-cycle changes further. Now, after an initial increase in <code class="docutils literal notranslate"><span class="pre">sales</span></code>, we observe a gradual decrease over time.</p>
<p>Do online-only firms have different <code class="docutils literal notranslate"><span class="pre">sales</span></code> life-cycles with respect to mixed online-offline firms? We can produce different binned scatterplots by group using the option <code class="docutils literal notranslate"><span class="pre">by</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate binsreg</span>
<span class="n">br_est</span> <span class="o">=</span> <span class="n">binscatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;online&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sales</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">br_est</span><span class="p">[</span><span class="s2">&quot;online&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">br_est</span><span class="p">[</span><span class="s2">&quot;online&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="c1"># plot the two groups</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">sns_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">so</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">br_est</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;online&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">Dots</span><span class="p">(</span><span class="n">pointsize</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">br_est</span><span class="p">[</span><span class="s2">&quot;online&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">br_est</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">br_est</span><span class="p">[</span><span class="s2">&quot;online&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">value</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binscatter: sales as a function of age conditioned on products&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">sns_plot</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/econmt-regression_172_0.svg" src="_images/econmt-regression_172_0.svg" /></div>
</div>
<p>From the binned scatterplot, we can see that online products have on average shorter lifetimes, with a higher initial peak in sales, followed by a sharper decline.</p>
<p>Hopefully this shows you how you can use <strong>binsreg</strong> to get a better understanding of causal relationships in your data.</p>
<p>You can find out more about bin scatters in this <a class="reference external" href="https://www.youtube.com/watch?v=fg9T2gPZCIs&amp;ab_channel=PaulGoldsmith-Pinkham">video</a> by Paul Goldsmith-Pinkham.</p>
</section>
<section id="specification-curve-analysis">
<h2>Specification curve analysis<a class="headerlink" href="#specification-curve-analysis" title="Permalink to this headline">#</a></h2>
<p>When specifying a model, modellers have many options. These can be informed by field intelligence, priors, and even misguided attempts to find a significant result. Even with the best of intentions, research teams can reach entirely different conclusions using the same, or similar, data because of different choices made in preparing data or in modelling it.</p>
<p>There’s formal evidence that researchers really do make different decisions; one study <span id="id6">Silberzahn <em>et al.</em> [<a class="reference internal" href="zreferences.html#id8" title="Raphael Silberzahn, Eric L Uhlmann, Daniel P Martin, Pasquale Anselmi, Frederik Aust, Eli Awtrey, Štěpán Bahník, Feng Bai, Colin Bannard, Evelina Bonnier, and others. Many analysts, one data set: making transparent how variations in analytic choices affect results. Advances in Methods and Practices in Psychological Science, 1(3):337–356, 2018.">2018</a>]</span> gave the same research question - whether soccer referees are more likely to give red cards to dark-skin-toned players than to light-skin-toned players - to 29 different teams. From the abstract of that paper:</p>
<blockquote>
<div><p>Analytic approaches varied widely across the teams, and the estimated effect sizes ranged from 0.89 to 2.93 (Mdn = 1.31) in odds-ratio units. Twenty teams (69%) found a statistically significant positive effect, and 9 teams (31%) did not observe a significant relationship. Overall, the 29 different analyses used 21 unique combinations of covariates. Neither analysts’ prior beliefs about the effect of interest nor their level of expertise readily explained the variation in the outcomes of the analyses. Peer ratings of the quality of the analyses also did not account for the variability.</p>
</div></blockquote>
<p>So not only were different decisions made, there seems to be no clearly identifiable reason for them. There is usually scope for reasonable alternative model specifications when estimating coefficients, and those coefficients will vary with those specifications.</p>
<p>Specification curve analysis <span id="id7">Simonsohn <em>et al.</em> [<a class="reference internal" href="zreferences.html#id9" title="Uri Simonsohn, Joseph P Simmons, and Leif D Nelson. Specification curve analysis. Nature Human Behaviour, 4(11):1208–1214, 2020.">2020</a>]</span> looks for a more exhaustive way of trying out alternative specifications. The three steps of specification curve analysis are:</p>
<ol class="simple">
<li><p>identifying the set of theoretically justified, statistically valid, and non-redundant analytic specifications;</p></li>
<li><p>displaying alternative results graphically, allowing the identification of decisions producing different results; and</p></li>
<li><p>conducting statistical tests to determine whether as a whole results are inconsistent with the null hypothesis.</p></li>
</ol>
<p>For a good example of specification curve analysis in action, see this recent Nature Human Behaviour paper <span id="id8">Orben and Przybylski [<a class="reference internal" href="zreferences.html#id10" title="Amy Orben and Andrew K Przybylski. The association between adolescent well-being and digital technology use. Nature Human Behaviour, 3(2):173–182, 2019.">2019</a>]</span> on the association between adolescent well-being and the use of digital technology.</p>
<p>We’ll use the <a class="reference external" href="https://specification-curve.readthedocs.io/en/latest/readme.html"><strong>specification curve analysis</strong></a> package to do the first two, which you can install with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">specification_curve</span></code>. To demonstrate the full functionality, we’ll create a second, alternative ‘hp’ that is a transformed version of the original.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpg</span><span class="p">[</span><span class="s2">&quot;hp_boxcox&quot;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">mpg</span><span class="p">[</span><span class="s2">&quot;hp&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s create a specification curve. We need to specify the data, the different outcome variables we’d like to try, <code class="docutils literal notranslate"><span class="pre">y_endog</span></code>; the different possible versions of the main regressor of interest, <code class="docutils literal notranslate"><span class="pre">x_exog</span></code>; the possible controls, <code class="docutils literal notranslate"><span class="pre">controls</span></code>; any controls that should always be included, <code class="docutils literal notranslate"><span class="pre">always_include</span></code>; and any categorical variables to include class-by-class, <code class="docutils literal notranslate"><span class="pre">cat_expand</span></code>. Some of these accept lists of variables as well as single reggressors. The point estimates that have confidence intervals which include zero are coloured in grey, instead of blue. There is also an <code class="docutils literal notranslate"><span class="pre">exclu_grps</span></code> option to exclude certain combinations of regressors, and you can pass alternative estimators to fit, for example <code class="docutils literal notranslate"><span class="pre">fit(estimator=sm.Logit)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">specification_curve</span> <span class="k">as</span> <span class="nn">specy</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">specy</span><span class="o">.</span><span class="n">SpecificationCurve</span><span class="p">(</span>
    <span class="n">mpg</span><span class="p">,</span>
    <span class="n">y_endog</span><span class="o">=</span><span class="s2">&quot;mpg&quot;</span><span class="p">,</span>
    <span class="n">x_exog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lnhp&quot;</span><span class="p">,</span> <span class="s2">&quot;hp_boxcox&quot;</span><span class="p">],</span>
    <span class="n">controls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drat&quot;</span><span class="p">,</span> <span class="s2">&quot;qsec&quot;</span><span class="p">,</span> <span class="s2">&quot;cyl&quot;</span><span class="p">,</span> <span class="s2">&quot;gear&quot;</span><span class="p">],</span>
    <span class="n">always_include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gear&quot;</span><span class="p">],</span>
    <span class="n">cat_expand</span><span class="o">=</span><span class="s2">&quot;cyl&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fit complete
</pre></div>
</div>
<img alt="_images/econmt-regression_177_1.svg" src="_images/econmt-regression_177_1.svg" /></div>
</div>
</section>
<section id="review">
<h2>Review<a class="headerlink" href="#review" title="Permalink to this headline">#</a></h2>
<p>In this very short introduction to regression with code, you should have learned how to:</p>
<ul class="simple">
<li><p>✅ perform linear OLS regressions with code;</p></li>
<li><p>✅ add fixed effects/categorical variables to regressions;</p></li>
<li><p>✅ use different standard errors;</p></li>
<li><p>✅ use models with transformed regressors;</p></li>
<li><p>✅ use the formula or array APIs for <strong>statsmodels</strong> and <strong>linearmodels</strong>;</p></li>
<li><p>✅ show the results from multiple models;</p></li>
<li><p>✅ perform IV regressions;</p></li>
<li><p>✅ perform GLM regressions; and</p></li>
<li><p>✅ use plots as a way to interrogate regression results.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="econmt-statistics.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Statistics</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="econmt-causal-inference.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Causal Inference</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Arthur Turrell<br/>
  
      &copy; Copyright 2022.<br/>
    <div class="extra_footer">
      This book is available under an MIT license.
    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>